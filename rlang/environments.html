<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.76.5" />
    <meta name="description" content="é€²éš">


    <link rel="shortcut icon" href="../images/favicon.png" type="image/x-icon" />
<link rel="icon" href="../images/favicon.png" type="image/x-icon" />

    <title>Environment - R in Class</title>

    
    <link href="../css/nucleus.css?1608182905" rel="stylesheet">
    <link href="../css/fontawesome-all.min.css?1608182905" rel="stylesheet">
    <link href="../css/hybrid.css?1608182905" rel="stylesheet">
    <link href="../css/featherlight.min.css?1608182905" rel="stylesheet">
    <link href="../css/perfect-scrollbar.min.css?1608182905" rel="stylesheet">
    <link href="../css/auto-complete.css?1608182905" rel="stylesheet">
    <link href="../css/atom-one-dark-reasonable.css?1608182905" rel="stylesheet">
    <link href="../css/theme.css?1608182905" rel="stylesheet">
    <link href="../css/hugo-theme.css?1608182905" rel="stylesheet">
    
    <link href="../extra_theme/css/mystyle.css?1608182905" rel="stylesheet"><link href="../extra_theme/css/demoContainer.css?1608182905" rel="stylesheet"><link href="../extra_theme/css/rmd.css?1608182905" rel="stylesheet">

    <script src="../js/jquery-3.3.1.min.js?1608182905"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="../rlang/environments.html">

    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="https://airbon5.github.io/xx/">
  <img src=../extra_theme/images/rmi.png>
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="../js/lunr.min.js?1608182905"></script>
<script type="text/javascript" src="../js/auto-complete.js?1608182905"></script>
<script type="text/javascript">
    
        var baseurl = "\/";
    
</script>
<script type="text/javascript" src="../js/search.js?1608182905"></script>

    
  </div>
  
    <section id="homelinks">
      <ul>
        <li>
            <a class="padding" href='../'><i class='fas fa-home'></i> Home</a>
        </li>
      </ul>
    </section>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/rlang.html" title="R language" class="dd-item
        parent
        
        
        ">
      <a href="../rlang.html">
          R language
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/rlang/requirement.html" title="Requirement" class="dd-item ">
        <a href="../rlang/requirement.html">
        Requirement
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/data_explorer_1.html" title="data explorer 1" class="dd-item ">
        <a href="../rlang/data_explorer_1.html">
        data explorer 1
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/data_explorer_2.html" title="data explorer 2" class="dd-item ">
        <a href="../rlang/data_explorer_2.html">
        data explorer 2
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/quickview1.html" title="Quick view 1" class="dd-item ">
        <a href="../rlang/quickview1.html">
        Quick view 1
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/regular_expression.html" title="Regular expression syntax" class="dd-item ">
        <a href="../rlang/regular_expression.html">
        Regular expression syntax
        
        </a>
    </li>
     
  
 

            
          
            
            
          
            
            




 
  
    
      <li data-nav-id="/rlang/type_basic.html" title="type basic" class="dd-item ">
        <a href="../rlang/type_basic.html">
        type basic
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/type_list.html" title="type list" class="dd-item ">
        <a href="../rlang/type_list.html">
        type list
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/type_matrix.html" title="type matrix" class="dd-item ">
        <a href="../rlang/type_matrix.html">
        type matrix
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/type_more.html" title="type more" class="dd-item ">
        <a href="../rlang/type_more.html">
        type more
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/type_post.html" title="type post" class="dd-item ">
        <a href="../rlang/type_post.html">
        type post
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/type_string_function.html" title="type string" class="dd-item ">
        <a href="../rlang/type_string_function.html">
        type string
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/type_vector.html" title="type vector" class="dd-item ">
        <a href="../rlang/type_vector.html">
        type vector
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/filesystem.html" title="File System" class="dd-item ">
        <a href="../rlang/filesystem.html">
        File System
        
        </a>
    </li>
     
  
 

            
          
            
            
          
            
            




 
  
    
      <li data-nav-id="/rlang/programming_1.html" title="Programming 1" class="dd-item ">
        <a href="../rlang/programming_1.html">
        Programming 1
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/apply_family.html" title="function - apply family" class="dd-item ">
        <a href="../rlang/apply_family.html">
        function - apply family
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/function_1.html" title="Function basic" class="dd-item ">
        <a href="../rlang/function_1.html">
        Function basic
        
        </a>
    </li>
     
  
 

            
          
            
            
          
            
            




 
  
    
      <li data-nav-id="/rlang/rpackages.html" title="R Package" class="dd-item ">
        <a href="../rlang/rpackages.html">
        R Package
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/plot01.html" title="Plot 01" class="dd-item ">
        <a href="../rlang/plot01.html">
        Plot 01
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/plot02.html" title="Plot more" class="dd-item ">
        <a href="../rlang/plot02.html">
        Plot more
        
        </a>
    </li>
     
  
 

            
          
            
            
          
            
            




 
  
    
      <li data-nav-id="/rlang/environments.html" title="Environment" class="dd-item active">
        <a href="../rlang/environments.html">
        Environment
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/sampling.html" title="sampling" class="dd-item ">
        <a href="../rlang/sampling.html">
        sampling
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/eco_01_intro.html" title="Econometrics" class="dd-item ">
        <a href="../rlang/eco_01_intro.html">
        Econometrics
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/sim_1.html" title="simulation 1" class="dd-item ">
        <a href="../rlang/sim_1.html">
        simulation 1
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/rlang/hw.html" title="ç·´ç¿’ç”¨" class="dd-item
        
        
        
        ">
      <a href="../rlang/hw.html">
          ç·´ç¿’ç”¨
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/rlang/hw/dataset_class.html" title="è³‡æ–™é›†" class="dd-item ">
        <a href="../rlang/hw/dataset_class.html">
        è³‡æ–™é›†
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/hw/hw_filesystem.html" title="æª”æ¡ˆç³»çµ±" class="dd-item ">
        <a href="../rlang/hw/hw_filesystem.html">
        æª”æ¡ˆç³»çµ±
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/hw/hw_basic.html" title="assignment-1" class="dd-item ">
        <a href="../rlang/hw/hw_basic.html">
        assignment-1
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/hw/hw_regexp.html" title="regexpr" class="dd-item ">
        <a href="../rlang/hw/hw_regexp.html">
        regexpr
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/rlang/resources.html" title="ç·´ç¿’ç›¸é—œæª”æ¡ˆ" class="dd-item
        
        
        
        ">
      <a href="../rlang/resources.html">
          ç·´ç¿’ç›¸é—œæª”æ¡ˆ
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/topic.html" title="Topics" class="dd-item
        
        
        
        ">
      <a href="../topic.html">
          Topics
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/topic/rmd/rmd_basic.html" title="Rmd basic" class="dd-item ">
        <a href="../topic/rmd/rmd_basic.html">
        Rmd basic
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/topic/rmd/rmd_hook.html" title="Rmd hook" class="dd-item ">
        <a href="../topic/rmd/rmd_hook.html">
        Rmd hook
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/topic/rmd/rmd_pdf.html" title="Rmd pdf" class="dd-item ">
        <a href="../topic/rmd/rmd_pdf.html">
        Rmd pdf
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/topic/rmd/rmd_topic_1.html" title="rmd topic 1" class="dd-item ">
        <a href="../topic/rmd/rmd_topic_1.html">
        rmd topic 1
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/topic/rmd/git-book-note.html" title="git book note" class="dd-item ">
        <a href="../topic/rmd/git-book-note.html">
        git book note
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/topic/interesting.html" title="interesting" class="dd-item ">
        <a href="../topic/interesting.html">
        interesting
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/topic/experiment.html" title="å¯¦é©—" class="dd-item
        
        
        
        ">
      <a href="../topic/experiment.html">
          å¯¦é©—
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/topic/experiment/central.html" title="ä¸­å¤®" class="dd-item ">
        <a href="../topic/experiment/central.html">
        ä¸­å¤®
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/topic/test.html" title="ç¶²é æ¸¬è©¦" class="dd-item
        
        
        
        ">
      <a href="../topic/test.html">
          ç¶²é æ¸¬è©¦
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/topic/test/emo_test.html" title="emoji_test" class="dd-item ">
        <a href="../topic/test/emo_test.html">
        emoji_test
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/topic/test/testpage.html" title="testpage" class="dd-item ">
        <a href="../topic/test/testpage.html">
        testpage
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='../'>class log</a> > <a href='../rlang.html'>R language</a> > Environment
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li><a href="#environments">Environments</a>
<ul>
<li><a href="#introduction">Introduction</a>
<ul>
<li><a href="#quiz">Quiz {-}</a></li>
<li><a href="#outline">Outline {-}</a></li>
<li><a href="#prerequisites">Prerequisites {-}</a></li>
</ul></li>
<li><a href="#env-basics">Environment basics</a>
<ul>
<li><a href="#basics">Basics</a></li>
<li><a href="#important-environments">Important environments</a></li>
<li><a href="#parents">Parents</a></li>
<li><a href="#getting-and-setting">Getting and setting</a></li>
<li><a href="#finalisers">Finalisers</a></li>
<li><a href="#advanced-bindings">Advanced bindings</a></li>
<li><a href="#exercises">Exercises</a></li>
</ul></li>
<li><a href="#env-recursion">Recursing over environments</a>
<ul>
<li><a href="#exercises-1">Exercises</a></li>
</ul></li>
<li><a href="#function-envs">Special environments</a>
<ul>
<li><a href="#package-environments-and-the-search-path">Package environments and the search path</a></li>
<li><a href="#the-function-environment">The function environment</a></li>
<li><a href="#namespaces">Namespaces</a></li>
<li><a href="#execution-environments">Execution environments</a></li>
<li><a href="#exercises-2">Exercises</a></li>
</ul></li>
<li><a href="#the-call-stack">The call stack</a>
<ul>
<li><a href="#simple-call-stacks">Simple call stacks</a></li>
<li><a href="#lazy-evaluation">Lazy evaluation</a></li>
<li><a href="#frames">Frames</a></li>
<li><a href="#dynamic-scope">Dynamic scope</a></li>
<li><a href="#exercises-3">Exercises</a></li>
</ul></li>
<li><a href="#explicit-envs">As data structures</a></li>
<li><a href="#toc_28"><code>&lt;&lt;-</code></a>
<ul>
<li><a href="#exercises-4">Exercises</a></li>
</ul></li>
<li><a href="#env-answers">Quiz answers</a>
<ul>
<li><a href="#term">term</a>
<ul>
<li>
<ul>
<li><a href="#global-environment">global environment :ç¸½é«”ç’°å¢ƒ</a></li>
<li><a href="#package-environments">package environments</a></li>
<li><a href="#imports-environment">imports environment</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Environment

            </h1>
			
          

        




<h1 id="environments">Environments</h1>

<p>åƒè€ƒ<br />
<a href="https://holtzy.github.io/Pimp-my-rmd/">https://holtzy.github.io/Pimp-my-rmd/</a></p>

<h2 id="introduction">Introduction</h2>

<p>The environment is the data structure that powers scoping.  ç›¸é—œæ¦‚å¿µ:lexical scoping, namespaces, and R6 classesã€‚</p>

<p>é€™å€‹æ–‡ä»¶éœ€è¦</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">devtools<span style="color:#f92672">::</span><span style="color:#a6e22e">install_github</span>(<span style="color:#e6db74">&#34;tidyverse/rlang&#34;</span>)</code></pre></div>
<h3 id="quiz">Quiz {-}</h3>

<p>If you can answer the following questions correctly, you already know the most important topics in this chapter. You can find the answers at the end of the chapter in <a href="#env-answers">answers</a>.</p>

<ol>
<li><p>List at least three ways that an environment is different to a list.</p></li>

<li><p>What is the parent of the global environment? What is the only<br />
environment that doesn&rsquo;t have a parent?</p></li>

<li><p>What is the enclosing environment of a function? Why is it<br />
important?</p></li>

<li><p>How do you determine the environment from which a function was called?</p></li>

<li><p>How are <code>&lt;-</code> and <code>&lt;&lt;-</code> different?</p></li>
</ol>

<h3 id="outline">Outline {-}</h3>

<ul>
<li><p><a href="#env-basics">Environment basics</a> introduces you to the basic properties<br />
of an environment and shows you how to create your own.</p></li>

<li><p><a href="#env-recursion">Recursing over environments</a> provides a function template<br />
for computing with environments, illustrating the idea with a useful<br />
function.</p></li>

<li><p><a href="#explicit-envs">Explicit environments</a> briefly discusses three places where<br />
environments are useful data structures for solving other problems.</p></li>
</ul>

<h3 id="prerequisites">Prerequisites {-}</h3>

<p>é€™å€‹ç« ç¯€åˆ©ç”¨äº†å¥—ä»¶<code>rlang</code>è£¡çš„å‡½æ•¸ï¼Œä¾†æ¢ç´¢ç’°å¢ƒç‰©ä»¶ã€‚</p>

<p>åœ¨<code>rlang</code>å¥—ä»¶ä¸­,<code>env_</code>å‡½æ•¸æ˜¯è¨­è¨ˆç”¨ä¾†å’Œpipeä¸€èµ·å·¥ä½œçš„,é€™è£¡ä¸æ·±å…¥ã€‚</p>


<div class="notices sidebar" ><p><p><code>global_env()</code>å’Œ<code>globalenv()</code>çš„åŸ·è¡Œçµæœä¸€æ¨£ã€‚</p><br />
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">  .GlobalEnv<br />
  <span style="color:#75715e">#&gt; &lt;environment: R_GlobalEnv&gt;</span><br />
  <span style="color:#a6e22e">globalenv</span>()<br />
  <span style="color:#75715e">#&gt; &lt;environment: R_GlobalEnv&gt;</span><br />
  <span style="color:#a6e22e">global_env</span>()<br />
  <span style="color:#75715e">#&gt; &lt;environment: R_GlobalEnv&gt;</span></p>

<p>.BaseNamespaceEnv<br />
  <span style="color:#75715e">#&gt; &lt;environment: namespace:base&gt;</span><br />
  <span style="color:#a6e22e">current_env</span>() <span style="color:#75715e">#</span><br />
  <span style="color:#75715e">#&gt; &lt;environment: R_GlobalEnv&gt;</span></code></pre></div></p>
</div>


<h2 id="env-basics">Environment basics</h2>

<p>åŸºæœ¬ä¸Šä¸€å€‹ environment é¡ä¼¼åç¨±ä¸²åˆ—(named list),ä½†æ˜¯æœ‰4å€‹ä¾‹å¤–:</p>

<ul>
<li>åç¨±å”¯ä¸€(å°±æ˜¯è®Šæ•¸å”¯ä¸€)<br /></li>
<li>åç¨±æ²’æœ‰é †åºé—œä¿‚<br /></li>
<li>æœƒæœ‰ä¸€å€‹parent<br /></li>
<li>ç•¶æ”¹è®Šçš„æ™‚å€™,ä¸æœƒè‡ªå‹•è¤‡è£½ (Environments are not copied when modified).<br />
<br /></li>
</ul>

<p>åˆ†åˆ¥æ¢ç´¢ä¸Šé¢å››é»:</p>

<h3 id="basics">Basics</h3>

<p>è¦å»ºç«‹environment, ä½¿ç”¨ <code>rlang::env()</code>. é¡ä¼¼ä½¿ç”¨<code>list()</code>,ä¹Ÿæ˜¯ä¸€çµ„åç¨±-å€¼çš„é…å°ã€‚:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">e1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">env</span>(
  a <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>,
  b <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;a&#34;</span>,
  c <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.3</span>,
  d <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">3</span>
)</code></pre></div>
<p>::: base<br />
å»ºç«‹environmentç‰©ä»¶,åˆ©ç”¨å‡½æ•¸ <code>new.env()</code> ä¸ç”¨ç®¡åƒæ•¸ <code>hash</code> å’Œ <code>size</code>ã€‚æ³¨æ„ä¸èƒ½åˆ©ç”¨<code>$&lt;-</code>åŒæ™‚å®šç¾©å’Œå»ºç«‹ parameters; ä¾‹å¦‚,<br />
e1 &lt;- env( ** a &lt;- FALSE ** ) # error<br />
  .<br />
:::</p>

<p>environmentç‰©ä»¶å¯ä»¥æƒ³æˆæ˜¯ä¸€å€‹è¢‹å­,æˆ–æ˜¯namesé›†åˆã€‚å› ç‚ºæ²’æœ‰æ¬¡åºé—œä¿‚</p>

<p><img src="../diagrams/environments/bindings.png" alt="plot of chunk unnamed-chunk-5" /></p>

<p>å°±åƒåœ¨ <a href="#env-modify">names and values</a>, è¨è«–çš„,é€™å€‹ç‰©ä»¶æ˜¯åƒè€ƒç‚ºåŸºç¤.(in C concept) ä¸æœƒæœ‰copy on modifyingã€‚è€Œä¸”,ç’°å¢ƒç‰©ä»¶å¯ä»¥è‡ªå·±æŒ‡å‘è‡ªå·±(recursion)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">e1<span style="color:#f92672">$</span>d <span style="color:#f92672">&lt;-</span> e1</code></pre></div>
<p><img src="../diagrams/environments/loop.png" alt="plot of chunk unnamed-chunk-7" /></p>

<p>æ²’æœ‰æŒ‡æ´¾çš„ç’°å¢ƒè®Šæ•¸,åªæœƒé¡¯ç¤ºè¨˜æ†¶é«”ä½å€:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">e1
<span style="color:#75715e">#&gt; &lt;environment: 0x000000001459cda0&gt;</span></code></pre></div>
<p>è¦çŸ¥é“å…§å®¹å¯ä»¥ä½¿ç”¨ <code>env_print()</code> :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">env_print</span>(e1)
<span style="color:#75715e">#&gt; &lt;environment: 000000001459CDA0&gt;</span>
<span style="color:#75715e">#&gt; parent: &lt;environment: global&gt;</span>
<span style="color:#75715e">#&gt; bindings:</span>
<span style="color:#75715e">#&gt;  * a: &lt;lgl&gt;</span>
<span style="color:#75715e">#&gt;  * b: &lt;chr&gt;</span>
<span style="color:#75715e">#&gt;  * c: &lt;dbl&gt;</span>
<span style="color:#75715e">#&gt;  * d: &lt;env&gt;</span></code></pre></div>
<p>æƒ³è¦çŸ¥é“ç›®å‰æœ‰å“ªäº›binding(åç¨±-å€¼ é…å°)å¯ä»¥åˆ©ç”¨ <code>env_names()</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">env_names</span>(e1)
<span style="color:#75715e">#&gt; [1] &#34;a&#34; &#34;b&#34; &#34;c&#34; &#34;d&#34;</span></code></pre></div>
<p>::: base<br />
è¦åˆ—å‡ºç’°å¢ƒä¸‹çš„ç¹«çµï¼Œåœ¨R 3.2.0 ä»¥ä¸Š,å¯ä»¥ä½¿ç”¨å‡½æ•¸<code>names()</code> ,ä¹‹å‰çš„ç‰ˆæœ¬å‰‡æ˜¯ <code>ls()</code>, ä½†æ˜¯è¦æ³¨æ„çš„æ˜¯ls çš„åƒæ•¸ <code>all.names</code> å…§è¨­æ˜¯ <code>FALSE</code> å› æ­¤<code>.</code>é–‹é ­çš„çœ‹ä¸åˆ°ã€‚.<br />
:::</p>

<h3 id="important-environments">Important environments</h3>

<p>å¦å¤–åƒè€ƒ [Special environments]ã€‚<br />
 <code>current_env()</code> å¯ä»¥çŸ¥é“ç›®å‰ç¨‹å¼ç¢¼çš„åŸ·è¡Œç’°å¢ƒã€‚ä¾‹å¦‚,ç•¶æˆ‘å€‘äº’å‹•åŸ·è¡ŒRCODEçš„æ™‚å€™,ç’°å¢ƒé€šå¸¸æ˜¯ <a href="#global environment">ç¸½é«”ç’°å¢ƒ</a>,æˆ–è€…ç”±å‡½æ•¸<code>global_env()</code>å¯ä»¥å¾—åˆ°ã€‚é€™å€‹ç¸½é«”ç’°å¢ƒæœ‰æ™‚å€™å°±å«&rdquo;workspace&rdquo;ï¼ŒåŒæ™‚,é€™ä¹Ÿæ˜¯å‡½æ•¸å¤–é¢æ‰€æœ‰äº’å‹•è¨ˆç®—ç™¼ç”Ÿçš„åœ°æ–¹ã€‚<br />
ç’°å¢ƒç‰©ä»¶çš„æ¯”è¼ƒä¸èƒ½ç”¨<code>==</code>,åªèƒ½ç”¨å‡½æ•¸<code>identical()</code>ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">identical</span>(<span style="color:#a6e22e">global_env</span>(), <span style="color:#a6e22e">current_env</span>())
<span style="color:#75715e">#&gt; [1] TRUE</span>

<span style="color:#a6e22e">global_env</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">current_env</span>()
<span style="color:#75715e">#&gt; Error in global_env() == current_env(): åªæœ‰åŸºå…ƒæˆ–ä¸²åˆ—é¡å‹æ‰èƒ½åšæ¯”è¼ƒ (1)</span></code></pre></div>
<p>:::base</p>

<ul>
<li><code>globalenv()</code> å’Œ<code>.GlobalEnv</code>: æ‹¿åˆ°global environmentandã€‚<br /></li>
<li><code>environment()</code>:æ‹¿åˆ°ç›®å‰çš„ç’°å¢ƒ<br />
<br /></li>
</ul>

<p>global environment çš„åç¨±ç‚º <code>R_GlobalEnv</code> ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">global_env</span>()
<span style="color:#75715e">#&gt; &lt;environment: R_GlobalEnv&gt;</span>
<span style="color:#a6e22e">current_env</span>()
<span style="color:#75715e">#&gt; &lt;environment: R_GlobalEnv&gt;</span>
.GlobalEnv
<span style="color:#75715e">#&gt; &lt;environment: R_GlobalEnv&gt;</span></code></pre></div>
<p>:::</p>

<h3 id="parents">Parents</h3>

<p>æ¯ä¸€å€‹ç’°å¢ƒç‰©ä»¶éƒ½æœ‰ä¸€å€‹*parent*ã€‚<em>parent</em> ä¹Ÿä¸€å€‹ç’°å¢ƒç‰©ä»¶ã€‚åœ¨æ–¹å¡Šåœ–ä¸­,parentä»¥è—è‰²åœˆè¡¨ç¤º,ä¸¦ç”¨ç®­é ­æŒ‡å‘å¦ä¸€å€‹ç’°å¢ƒç‰©ä»¶ã€‚</p>

<p>é€™å€‹parentç”¨ä¾†å»ºç«‹ lexical scoping: å¦‚æœnameæ²’æœ‰åœ¨æŸå€‹ç’°å¢ƒç‰©ä»¶æ‰¾åˆ°,Ræœƒé‡è¤‡çš„åœ¨parentä¸­æ‰¾ã€‚<br />
å‡½æ•¸<code>env()</code>å¯ä»¥ç”¨ä¾†å»ºç«‹ä¸€å€‹æ²’æœ‰åå­—çš„ç’°å¢ƒ<br />
You can set the parent environment by supplying an unnamed argument to <code>env()</code>. If you don&rsquo;t supply it, it defaults to the current environment.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">e2a <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">env</span>(d <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, e <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>)
e2b <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">env</span>(e2a, a <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, b <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, c <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>)</code></pre></div>
<p><img src="../diagrams/environments/parents.png" alt="plot of chunk unnamed-chunk-14" /></p>

<p>å‡½æ•¸ <code>env_parent()</code>å¯ä»¥ç”¨ä¾†æ‰¾å‡ºæŸå€‹ç’°å¢ƒç‰©ä»¶çš„parent:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">env_parent</span>(e2b)
<span style="color:#75715e">#&gt; &lt;environment: 0x000000001428d388&gt;</span>
<span style="color:#a6e22e">env_parent</span>(e2a)
<span style="color:#75715e">#&gt; &lt;environment: R_GlobalEnv&gt;</span></code></pre></div>
<dl>
<dt>parent.env() === env_parent()<br />
<br /></dt>
</dl>

<dl>
<dt>arent()<br />
<br /></dt>
</dl>

<p>:::</p>

<p>æ‰€æœ‰çš„ç’°å¢ƒç‰©ä»¶ä¸­åªæœ‰ä¸€å€‹åç¨±ç‚º<code>R_EmptyEnv</code>çš„ç‰©ä»¶æ²’æœ‰parent(ç”¨ç©ºå¿ƒè—è‰²è¡¨ç¤º):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">e2c <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">env</span>(<span style="color:#a6e22e">empty_env</span>(), d <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, e <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>)
e2d <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">env</span>(e2c, a <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, b <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, c <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>)</code></pre></div>
<dl>
<dt><img src="../diagrams/environments/parents-empty.png" alt="plot of chunk unnamed-chunk-17" /><br />
<br /></dt>
<dt>::: base<br />
emptyenv()  === empty_env()<br />
<br /></dt>
</dl>

<p>:::</p>

<p>è©¦åœ–åˆ©ç”¨å‡½æ•¸<code>env_parent()</code>æ‰¾ç©ºç’°å¢ƒç‰©ä»¶çš„parentæœƒç™¼ç”ŸéŒ¯èª¤:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">env_parent</span>(<span style="color:#a6e22e">empty_env</span>())
<span style="color:#75715e">#&gt; Error: The empty environment has no parent</span></code></pre></div>
<p>å‡½æ•¸ <code>env_parents()</code>å¯ä»¥æ‰¾å‡ºç›®å‰ç’°å¢ƒç‰©ä»¶çš„æ‰€æœ‰ç¥–å…ˆ:é€™å€‹å‡½æ•¸æœƒç¹¼çºŒç›´åˆ°é‡ä¸Šglobal environment æˆ–æ˜¯ç©ºç’°å¢ƒç‰©ä»¶ã€‚ä¸Šè¿°éç¨‹å¯ä»¥åˆ©ç”¨<code>last</code>ç’°å¢ƒç‰©ä»¶æ§åˆ¶ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">env_parents</span>(e2b)
<span style="color:#75715e">#&gt; [[1]]   &lt;env: 000000001428D388&gt;</span>
<span style="color:#75715e">#&gt; [[2]] $ &lt;env: global&gt;</span>

<span style="color:#a6e22e">env_parents</span>(e2d)
<span style="color:#75715e">#&gt; [[1]]   &lt;env: 0000000013614530&gt;</span>
<span style="color:#75715e">#&gt; [[2]] $ &lt;env: empty&gt;</span></code></pre></div>
<dl>
<dt>å¯ä»¥åˆ©ç”¨Use <code>parent.env()</code> æ‰¾åˆ°ç’°å¢ƒçš„parentï¼Œä½†æ˜¯baseä¸­æ²’æœ‰å¯ä»¥æ‰¾å‡ºæ‰€æœ‰ç¥–å…ˆçš„å‡½æ•¸ã€‚<br />
<br /></dt>
</dl>

<dl>
<dt>‡½æ•¸ã€‚<br />
<br /></dt>
</dl>

<p>:::</p>

<h3 id="getting-and-setting">Getting and setting</h3>

<p>å­˜å–ç’°å¢ƒä¸­å…ƒç´ çš„æ–¹æ³•å’Œlisté¡ä¼¼:ä½¿ç”¨ <code>$</code> å’Œ <code>[[</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">e3 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">env</span>(x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
e3<span style="color:#f92672">$</span>x
<span style="color:#75715e">#&gt; [1] 1</span>
e3<span style="color:#f92672">$</span>z <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">3</span>
e3[[<span style="color:#e6db74">&#34;z&#34;</span>]]
<span style="color:#75715e">#&gt; [1] 3</span></code></pre></div>
<p>ä½†æ˜¯ä¸èƒ½ä½¿ç”¨ <code>[[</code> +æ•¸å­—ç´¢å¼•,ä¹Ÿä¸èƒ½å–®ç¨ä½¿ç”¨ <code>[</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">e3[[1]]
<span style="color:#75715e">#&gt; Error in e3[[1]]: å–å­é›†ç’°å¢ƒæ™‚çš„å¼•æ•¸ä¸æ­£ç¢º</span>

e3<span style="color:#a6e22e">[c</span>(<span style="color:#e6db74">&#34;x&#34;</span>, <span style="color:#e6db74">&#34;y&#34;</span>)]
<span style="color:#75715e">#&gt; Error in e3[c(&#34;x&#34;, &#34;y&#34;)]: &#39;environment&#39; é¡å‹çš„ç‰©ä»¶ç„¡æ³•å…·æœ‰å­é›†åˆ</span></code></pre></div>
<p>ç•¶ç’°å¢ƒä¸­çš„ç¹«çµä¸å­˜åœ¨æ™‚(ç°¡å–®é»,å°±æ˜¯è®Šæ•¸ä¸å­˜åœ¨æ™‚)<code>$</code> å’Œ <code>[[</code> æœƒå‚³å› <code>NULL</code> ä½†ä¸æœƒå¼•ç™¼éŒ¯èª¤,å¦‚æœè¦æœ‰éŒ¯èª¤è­¦å‘Š,å‰‡åˆ©ç”¨ <code>env_get()</code> :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">e3<span style="color:#f92672">$</span>xyz
<span style="color:#75715e">#&gt; NULL</span>

<span style="color:#a6e22e">env_get</span>(e3, <span style="color:#e6db74">&#34;xyz&#34;</span>)
<span style="color:#75715e">#&gt; Error in env_get(e3, &#34;xyz&#34;): ç¼ºå°‘å¼•æ•¸ &#34;default&#34;ï¼Œä¹Ÿæ²’æœ‰é è¨­å€¼</span></code></pre></div>
<p>ç•¶ç¹«çµä¸å­˜åœ¨,ä½†æ˜¯æƒ³è¦æœ‰é è¨­å€¼å‚³å›æ™‚,å¯ä»¥åˆ©ç”¨åƒæ•¸ <code>default</code> .</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">env_get</span>(e3, <span style="color:#e6db74">&#34;xyz&#34;</span>, default <span style="color:#f92672">=</span> <span style="color:#66d9ef">NA</span>)
<span style="color:#75715e">#&gt; [1] NA</span></code></pre></div>
<p>å¦æœ‰å…©ç¨®æ–¹å¼å¯ä»¥åœ¨ç’°å¢ƒç‰©ä»¶åŠ å…¥ç¹«çµ:</p>

<ul>
<li><p><code>env_poke()</code>[^poke] takes a name (as string) and a value:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">env_poke</span>(e3, <span style="color:#e6db74">&#34;a&#34;</span>, <span style="color:#ae81ff">100</span>)
e3<span style="color:#f92672">$</span>a
<span style="color:#75715e">#&gt; [1] 100</span></code></pre></div>
<p>[^poke]: You might wonder why rlang has <code>env_poke()</code> instead of <code>env_set()</code>.<br />
This is for consistency: <code>_set()</code> functions return a modified copy;<br />
<code>_poke()</code> functions modify in place.</p></li>

<li><p><code>env_bind()</code> allows you to bind multiple values:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">env_bind</span>(e3, a <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, b <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>)
<span style="color:#a6e22e">env_names</span>(e3)
<span style="color:#75715e">#&gt; [1] &#34;x&#34; &#34;y&#34; &#34;z&#34; &#34;a&#34; &#34;b&#34;</span></code></pre></div></li>
</ul>

<p><code>env_has()</code>: æ˜¯å¦ç’°å¢ƒä¸­æœ‰ç¹«çµ</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">env_has</span>(e3, <span style="color:#e6db74">&#34;a&#34;</span>)
<span style="color:#75715e">#&gt;    a </span>
<span style="color:#75715e">#&gt; TRUE</span></code></pre></div>
<p>ä¸èƒ½åƒæ˜¯listä¸­åˆªé™¤å…ƒç´ çš„æ–¹å¼(æŒ‡æ´¾<code>NULL</code>çµ¦å…ƒç´ )ï¼Œè€Œå¿…é ˆä½¿ç”¨ <code>env_unbind()</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">e3<span style="color:#f92672">$</span>a <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">NULL</span>
<span style="color:#a6e22e">env_has</span>(e3, <span style="color:#e6db74">&#34;a&#34;</span>)
<span style="color:#75715e">#&gt;    a </span>
<span style="color:#75715e">#&gt; TRUE</span>

<span style="color:#a6e22e">env_unbind</span>(e3, <span style="color:#e6db74">&#34;a&#34;</span>)
<span style="color:#a6e22e">env_has</span>(e3, <span style="color:#e6db74">&#34;a&#34;</span>)
<span style="color:#75715e">#&gt;     a </span>
<span style="color:#75715e">#&gt; FALSE</span></code></pre></div>
<p>å¾ä¸€å€‹ç‰©ä»¶Unbinding è§£é™¤åç¨±ï¼Œä¸¦ä¸æœƒåˆªé™¤ç‰©ä»¶ï¼Œæ˜¯å¦åˆªé™¤ç‰©ä»¶æ˜¯ garbage collectorçš„å·¥ä½œ.ã€‚å¯ä»¥åƒè€ƒ <a href="#gc">GC</a>.</p>

<p>::: base</p>

<p>See <code>get()</code>, <code>assign()</code>, <code>exists()</code>, and <code>rm()</code>. These are designed interactively for use with the current environment, so working with other environments is a little clunky. Also beware the <code>inherits</code> argument: it defaults to <code>TRUE</code> meaning that the base equivalents will inspect the supplied environment and all its ancestors.<br />
:::</p>

<h3 id="finalisers">Finalisers</h3>

<p>[Add something once rlang has an API. Also mention in data structures below]{.todo}</p>

<h3 id="advanced-bindings">Advanced bindings</h3>

<p>There are two more exotic variants of <code>env_bind()</code>:</p>

<ul>
<li><p><code>env_bind_exprs()</code> creates <strong>delayed bindings</strong>, which are evaluated the<br />
first time they are accessed. Behind the scenes, delayed bindings create<br />
promises, so behave in the same way as function arguments.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">env_bind_exprs</span>(<span style="color:#a6e22e">current_env</span>(), b <span style="color:#f92672">=</span> {<span style="color:#a6e22e">Sys.sleep</span>(<span style="color:#ae81ff">1</span>); <span style="color:#ae81ff">1</span>})
<span style="color:#75715e">#&gt; Warning: `env_bind_exprs()` is deprecated as of rlang 0.3.0.</span>
<span style="color:#75715e">#&gt; Please use `env_bind_lazy()` instead.</span>
<span style="color:#75715e">#&gt; This warning is displayed once per session.</span>
    
<span style="color:#a6e22e">system.time</span>(<span style="color:#a6e22e">print</span>(b))
<span style="color:#75715e">#&gt; [1] 1</span>
<span style="color:#75715e">#&gt;    user  system elapsed </span>
<span style="color:#75715e">#&gt;    0.00    0.00    1.02</span>
<span style="color:#a6e22e">system.time</span>(<span style="color:#a6e22e">print</span>(b))
<span style="color:#75715e">#&gt; [1] 1</span>
<span style="color:#75715e">#&gt;    user  system elapsed </span>
<span style="color:#75715e">#&gt;       0       0       0</span></code></pre></div>
<p>Delayed bindings are used to implement <code>autoload()</code>, which makes R behave<br />
as if the package data is in memory, even though it&rsquo;s only loaded from<br />
disk when you ask for it.</p></li>

<li><p><code>env_bind_fns()</code> creates <strong>active bindings</strong> which are re-computed every<br />
time they&rsquo;re accessed:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">env_bind_fns</span>(<span style="color:#a6e22e">current_env</span>(), z1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">function</span>(val) <span style="color:#a6e22e">runif</span>(<span style="color:#ae81ff">1</span>))
<span style="color:#75715e">#&gt; Warning: `env_bind_fns()` is deprecated as of rlang 0.3.0.</span>
<span style="color:#75715e">#&gt; Please use `env_bind_active()` instead.</span>
<span style="color:#75715e">#&gt; This warning is displayed once per session.</span>
    
z1
<span style="color:#75715e">#&gt; [1] 0.6588047</span>
z1
<span style="color:#75715e">#&gt; [1] 0.436975</span></code></pre></div>
<p>The argument to the function allows you to also override behaviour when<br />
the variable is set:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">env_bind_fns</span>(<span style="color:#a6e22e">current_env</span>(), z2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">function</span>(val) {
  <span style="color:#a6e22e">if </span>(<span style="color:#a6e22e">missing</span>(val)) {
    <span style="color:#ae81ff">2</span>
  } else {
     <span style="color:#a6e22e">stop</span>(<span style="color:#e6db74">&#34;Don&#39;t touch z2!&#34;</span>, call. <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>)
  }
})
    
z2
<span style="color:#75715e">#&gt; [1] 2</span>
z2 <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">3</span>
<span style="color:#75715e">#&gt; Error: Don&#39;t touch z2!</span></code></pre></div></li>
</ul>

<p>::: base<br />
See  <code>?delayedAssign()</code> and <code>?makeActiveBinding()</code>.<br />
:::</p>

<h3 id="exercises">Exercises</h3>

<ol>
<li><p>List three ways in which an environment differs from a list.</p></li>

<li><p>Create an environment as illustrated by this picture.</p>

<p><img src="../diagrams/environments/recursive-1.png" alt="plot of chunk unnamed-chunk-31" /></p></li>

<li><p>Create a pair of environments as illustrated by this picture.</p>

<p><img src="../diagrams/environments/recursive-2.png" alt="plot of chunk unnamed-chunk-32" /></p></li>

<li><p>Explain why <code>e[[1]]</code> and <code>e[c(&quot;a&quot;, &quot;b&quot;)]</code> don&rsquo;t make sense when <code>e</code> is<br />
an environment.</p></li>

<li><p>Create a version of <code>env_poke()</code> that will only bind new names, never<br />
re-bind old names. Some programming languages only do this, and are known<br />
as <a href="http://en.wikipedia.org/wiki/Assignment_(computer_science)#Single_assignment">single assignment languages</a>.</p></li>
</ol>

<h2 id="env-recursion">Recursing over environments</h2>

<p>If you want to operate on every ancestor of an environment, it&rsquo;s often convenient to write a recursive function. This section shows you how, applying your new knowledge of environments to write a function that given a name, finds the environment <code>where()</code> that name is defined, using R&rsquo;s regular scoping rules.</p>

<p>The definition of <code>where()</code> is straightforward. It has two arguments: the name to look for (as a string), and the environment in which to start the search. (We&rsquo;ll learn why <code>caller_env()</code> is a good default in <a href="#calling-environments">calling environments</a>.)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">where <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(name, env <span style="color:#f92672">=</span> <span style="color:#a6e22e">caller_env</span>()) {
  <span style="color:#a6e22e">if </span>(<span style="color:#a6e22e">identical</span>(env, <span style="color:#a6e22e">empty_env</span>())) {
    <span style="color:#75715e"># Base case</span>
    <span style="color:#a6e22e">stop</span>(<span style="color:#e6db74">&#34;Can&#39;t find &#34;</span>, name, call. <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>)
  } else <span style="color:#a6e22e">if </span>(<span style="color:#a6e22e">env_has</span>(env, name)) {
    <span style="color:#75715e"># Success case</span>
    env
  } else {
    <span style="color:#75715e"># Recursive case</span>
    <span style="color:#a6e22e">where</span>(name, <span style="color:#a6e22e">env_parent</span>(env))
  }
}</code></pre></div>
<p>3å€‹æƒ…æ³:</p>

<ul>
<li><p>The base case: åˆ°é”empty environment æ²’æœ‰parentç„¡æ³•ç¹¼çºŒ,æ‰€ä»¥ä¸Ÿå‡ºerror.</p></li>

<li><p>The successful case: åœ¨envä¸­æ‰¾åˆ°name ï¼ŒæˆåŠŸ,æ‰€ä»¥å‚³å›envã€‚.</p></li>

<li><p>The recursive case: åœ¨envä¸­æ‰¾ä¸åˆ°,ç¹¼çºŒåœ¨parentä¸­æ‰¾ã€‚.</p></li>
</ul>

<p>These three cases are illustrated with these three examples:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">where</span>(<span style="color:#e6db74">&#34;yyy&#34;</span>)
<span style="color:#75715e">#&gt; Error: Can&#39;t find yyy</span>

x <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">5</span>
<span style="color:#a6e22e">where</span>(<span style="color:#e6db74">&#34;x&#34;</span>)
<span style="color:#75715e">#&gt; &lt;environment: R_GlobalEnv&gt;</span>

<span style="color:#a6e22e">where</span>(<span style="color:#e6db74">&#34;mean&#34;</span>)
<span style="color:#75715e">#&gt; &lt;environment: base&gt;</span></code></pre></div>
<p>æƒ³åƒæœ‰å…©å€‹ç’°å¢ƒç‰©ä»¶(å¦‚åœ–):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">e4a <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">env</span>(<span style="color:#a6e22e">empty_env</span>(), a <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, b <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
e4b <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">env</span>(e4a, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, a <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span>)</code></pre></div>
<p><img src="../diagrams/environments/where-ex.png" alt="plot of chunk unnamed-chunk-36" /></p>

<ul>
<li><p><code>where(a, e4a)</code> will find <code>a</code> in <code>e4a</code>.</p></li>

<li><p><code>where(&quot;b&quot;, e4a)</code> doesn&rsquo;t find <code>b</code> in <code>e4a</code>, so it looks in its parent, <code>e4b</code>,<br />
and finds it there.</p></li>

<li><p><code>where(&quot;c&quot;, e4a)</code> looks in <code>e4a</code>, then <code>e4b</code>, then hits the empty environment<br />
and throws an error.</p></li>
</ul>

<p>It&rsquo;s natural to work with environments recursively, so <code>where()</code> provides a useful template. Removing the specifics of <code>where()</code> shows the structure more clearly:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">f <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(<span style="color:#66d9ef">...</span>, env <span style="color:#f92672">=</span> <span style="color:#a6e22e">caller_env</span>()) {
  <span style="color:#a6e22e">if </span>(<span style="color:#a6e22e">identical</span>(env, <span style="color:#a6e22e">empty_env</span>())) {
    <span style="color:#75715e"># base case</span>
  } else <span style="color:#a6e22e">if </span>(success) {
    <span style="color:#75715e"># success case</span>
  } else {
    <span style="color:#75715e"># recursive case</span>
    <span style="color:#a6e22e">f</span>(<span style="color:#66d9ef">...</span>, env <span style="color:#f92672">=</span> <span style="color:#a6e22e">env_parent</span>(env))
  }
}</code></pre></div>

<div class="notices sidebar" ><h3 id="iteration-vs-recursion">Iteration vs recursion {-}</h3>

<p><p>ä¹Ÿå¯ä»¥ç”¨è¿­ä»£çš„æ–¹å¼</p><br />
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">f2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(<span style="color:#66d9ef">&hellip;</span>, env <span style="color:#f92672">=</span> <span style="color:#a6e22e">caller_env</span>()) {<br />
  <span style="color:#a6e22e">while </span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">identical</span>(env, <span style="color:#a6e22e">empty_env</span>())) {<br />
    <span style="color:#a6e22e">if </span>(success) {<br />
      <span style="color:#75715e"># success case</span><br />
      <span style="color:#a6e22e">return</span>()<br />
    }<br />
    <span style="color:#75715e"># inspect parent</span><br />
    env <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">env_parent</span>(env)<br />
  }</p>

<p><span style="color:#75715e"># base case</span><br />
}</code></pre></div></p>
</div>


<h3 id="exercises-1">Exercises</h3>

<ol>
<li><p>Modify <code>where()</code> to return <em>all</em> environments that contain a binding for<br />
<code>name</code>. Carefully think through what type of object the function will<br />
need to return.</p></li>

<li><p>Write a function called <code>fget()</code> that finds only function objects. It<br />
should have two arguments, <code>name</code> and <code>env</code>, and should obey the regular<br />
scoping rules for functions: if there&rsquo;s an object with a matching name<br />
that&rsquo;s not a function, look in the parent. For an added challenge, also<br />
add an <code>inherits</code> argument which controls whether the function recurses up<br />
the parents or only looks in one environment.</p></li>
</ol>

<h2 id="function-envs">Special environments</h2>

<p>é€™è£¡è¨è«– package environments. ç„¶å¾Œæ¢è¨ç•¶å‡½æ•¸å»ºç«‹æ™‚,ç¶å…¥å‡½æ•¸çš„å‡½æ•¸ç’°å¢ƒã€‚é‚„æœ‰ç•¶å‡½æ•¸è¢«å‘¼å«æ™‚çš„åŸ·è¡Œç’°å¢ƒ(ephemeral)ã€‚</p>

<p><a href="package-environments">å¥—è£ç’°å¢ƒ</a>ä¸»è¦æ˜¯çœ‹é€™äº›ç’°å¢ƒå¦‚ä½•æ”¯æ´namespacesã€‚åŒæ™‚,namespaceè®“packageæ¯æ¬¡è¼‰å…¥çš„æ™‚å€™,éƒ½æœ‰ä¸€æ¨£çš„è¡Œç‚º,è€Œä¸å”®å…¶ä»–packagesè¼‰å…¥å…ˆå¾Œçš„å½±éŸ¿ã€‚</p>

<h3 id="package-environments-and-the-search-path">Package environments and the search path</h3>

<p>æ¯å€‹å¥—ä»¶ç¶“ç”±<code>library()</code> æˆ– <code>require()</code> æ¥å…¥æˆç‚º<a href="#global-environment">ç¸½é«”ç’°å¢ƒ</a>çš„parentã€‚è€Œæœ€å¾Œä¸€å€‹<a href="#attach">æ¥å…¥</a>çš„å¥—ä»¶,å‰‡æ˜¯ç¸½é«”ç’°å¢ƒçš„ç¬¬ä¸€å€‹parent:</p>


<div class="notices sidebar" ><p><p>load å’Œ attachä¸ä¸€æ¨£ï¼Œç•¶æˆ‘å€‘ä½¿ç”¨libraryçš„æ™‚å€™,æˆ‘å€‘åšçš„æ˜¯<sup class="footnote-ref" id="fnref:attach"><a href="#fn:attach">1</a></sup> åœ¨ç’°å¢ƒä¸²åˆ—ä¸­åŠ å…¥æˆ‘å€‘åˆ©ç”¨libraryè¼‰å…¥çš„ç‰©ä»¶..</p><br />
<div class="footnotes"></p>

<hr />

<p><ol><br />
<li id="fn:attach">Note the difference between attached and loaded. A package is loaded automatically if you access one of its functions using <code>::</code>; it is only <strong>attached</strong> to the search path by <code>library()</code> or <code>require()</code>.<br />
<br /><br />
 <a class="footnote-return" href="#fnref:attach"><sup>[return]</sup></a></li><br />
</ol><br />
</div></p>
</div>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">env_parent</span>(<span style="color:#a6e22e">global_env</span>())
<span style="color:#75715e">#&gt; &lt;environment: package:foreign&gt;</span>
<span style="color:#75715e">#&gt; attr(,&#34;name&#34;)</span>
<span style="color:#75715e">#&gt; [1] &#34;package:foreign&#34;</span>
<span style="color:#75715e">#&gt; attr(,&#34;path&#34;)</span>
<span style="color:#75715e">#&gt; [1] &#34;C:/Program Files/R/R-4.0.2/library/foreign&#34;</span></code></pre></div>
<p>And the parent of that package is the second to last package you attached:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">env_parent</span>(<span style="color:#a6e22e">env_parent</span>(<span style="color:#a6e22e">global_env</span>()))
<span style="color:#75715e">#&gt; &lt;environment: package:moments&gt;</span>
<span style="color:#75715e">#&gt; attr(,&#34;name&#34;)</span>
<span style="color:#75715e">#&gt; [1] &#34;package:moments&#34;</span>
<span style="color:#75715e">#&gt; attr(,&#34;path&#34;)</span>
<span style="color:#75715e">#&gt; [1] &#34;C:/Program Files/R/R-4.0.2/library/moments&#34;</span></code></pre></div>
<p>å¦‚æœä¸€å±¤ä¸€å±¤parentå›æœ”,å°±å¯ä»¥åˆ°æ¯å€‹å¥—ä»¶è¢«æ¥å…¥çš„é †åº,é€™ä¹Ÿæ˜¯RåŸ·è¡Œä¸­æœƒç”¨åˆ°çš„ <strong>search path</strong> å› ç‚ºé€™äº›ç’°å¢ƒçš„æ‰€æœ‰ç‰©ä»¶éƒ½å¯ä»¥ç¶“ç”± top-level interactive workspaceæ‰¾åˆ°ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">search_envs</span>()
<span style="color:#75715e">#&gt;  [[1]] $ &lt;env: global&gt;</span>
<span style="color:#75715e">#&gt;  [[2]] $ &lt;env: package:foreign&gt;</span>
<span style="color:#75715e">#&gt;  [[3]] $ &lt;env: package:moments&gt;</span>
<span style="color:#75715e">#&gt;  [[4]] $ &lt;env: package:rlang&gt;</span>
<span style="color:#75715e">#&gt;  [[5]] $ &lt;env: package:stats&gt;</span>
<span style="color:#75715e">#&gt;  [[6]] $ &lt;env: package:graphics&gt;</span>
<span style="color:#75715e">#&gt;  [[7]] $ &lt;env: package:grDevices&gt;</span>
<span style="color:#75715e">#&gt;  [[8]] $ &lt;env: package:utils&gt;</span>
<span style="color:#75715e">#&gt;  [[9]] $ &lt;env: package:datasets&gt;</span>
<span style="color:#75715e">#&gt; [[10]] $ &lt;env: package:methods&gt;</span>
<span style="color:#75715e">#&gt; [[11]] $ &lt;env: Autoloads&gt;</span>
<span style="color:#75715e">#&gt; [[12]] $ &lt;env: package:base&gt;</span></code></pre></div>
<p>:::base<br />
å‡½æ•¸ <code>search()</code>å¯ä»¥æ‰¾å‡ºç’°å¢ƒç‰©ä»¶çš„åç¨±ã€‚<br />
:::</p>

<p>æœ€å¾Œå…©å€‹ç’°å¢ƒç‰©ä»¶éƒ½ä¸€æ¨£:</p>

<ul>
<li><p><code>Autoloads</code> ç’°å¢ƒç‰©ä»¶,åˆ©ç”¨ delayed bindingsä¾†ç¯€çœè¨˜æ†¶é«”ï¼Œä¹Ÿå°±æ˜¯åœ¨éœ€è¦çš„æ™‚å€™æ‰è¼‰å…¥(loading)packageä¸­çš„ç‰©ä»¶(ä¾‹å¦‚å¤§å‹è³‡æ–™é›†)ã€‚</p></li>

<li><p>base environment, <code>package:base</code> æˆ–ç°¡ç¨± <code>base</code>, æ˜¯base å¥—è£çš„ç’°å¢ƒç‰©ä»¶ã€‚ç”¨ä¾† è¼‰å…¥å…¶ä»–å¥—è£(bootstrap)ã€‚åˆ©ç”¨å‡½æ•¸ <code>base_env()</code>å­˜å–.</p></li>
</ul>

<p>åˆ©ç”¨åœ–å‹è¡¨ç¤º:</p>

<p><img src="../diagrams/environments/search-path.png" alt="plot of chunk unnamed-chunk-42" /></p>

<p>ç•¶åˆ©ç”¨ <code>library()</code> attachå…¶ä»–å¥—ä»¶çš„æ™‚å€™, ç¸½é«”ç’°å¢ƒçš„parenté¦¬ä¸Šæ”¹è®Š:</p>

<p><img src="../diagrams/environments/search-path-2.png" alt="plot of chunk unnamed-chunk-43" /></p>

<h3 id="the-function-environment">The function environment</h3>

<p>ç•¶å‡½æ•¸è¢«å»ºç«‹çš„æ™‚å€™,ç¾æœ‰çš„ç’°å¢ƒæœƒè¢«ç¹«çµã€‚ç¨±ç‚º<em>function environment</em>, ä¸»è¦ç”¨ä¾†æ”¯æ´lexical scoping. åœ¨é›»è…¦èªè¨€ä¸­,ç•¶å‡½æ•¸ç´€éŒ„å®ƒå€‘çš„é‹ä½œç’°å¢ƒæ™‚,æˆ‘å€‘èªªé€™å€‹å‡½æ•¸å±¬æ–¼ *closures*ã€‚,é€™ä¹Ÿæ˜¯ç‚ºç”šéº¼é€™å€‹å­—çœ¼ç¶“å¸¸åœ¨Rèªè¨€ä¸­å‡ºç¾ã€‚.</p>

<p>åˆ©ç”¨å‡½æ•¸ <code>fn_env()</code>å¯ä»¥å¾—åˆ°å‡½æ•¸çš„ç’°å¢ƒç‰©ä»¶:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">y <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>
f <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(x) x <span style="color:#f92672">+</span> y
<span style="color:#a6e22e">fn_env</span>(f)
<span style="color:#75715e">#&gt; &lt;environment: R_GlobalEnv&gt;</span></code></pre></div>
<p>::: base<br />
ä¸€æ¨£åˆ©ç”¨å‡½æ•¸ <code>environment(f)</code> å¯ä»¥æ‰¾åˆ°å‡½æ•¸ <code>f</code>çš„ç’°å¢ƒ.<br />
:::</p>

<p>åœ¨åœ–å½¢ä¸­,å‡½æ•¸è¢«ç•«æˆé¡ä¼¼å­å½ˆ,è€Œå½ˆé ­çš„éƒ¨åˆ†ç¹«çµç’°å¢ƒã€‚</p>

<p><img src="../diagrams/environments/binding.png" alt="plot of chunk unnamed-chunk-45" /></p>

<p>åœ¨é€™å€‹æ¡ˆä¾‹ä¸­,<code>f()</code>ç¹«çµçš„ç’°å¢ƒç‰©ä»¶,å°±æ˜¯ç¹«çµåç¨±<code>f</code>çš„ç’°å¢ƒã€‚ä½†ä¸¦ä¸ä¸€å®šç¸½æ˜¯é€™æ¨£ï¼Œä¾‹å¦‚åœ¨ä¸‹ä¸€å€‹ä¾‹å­ä¸­,<code>g</code>è¢«ç¹«çµåœ¨æ–°ç’°å¢ƒç‰©ä»¶<code>e</code>ä¸­ã€‚ä½†æ˜¯å‡½æ•¸<code>g()</code>ç¹«çµçš„æ˜¯global environmentã€‚é€™ä¹‹é–“çš„åˆ†åˆ¥æ˜¯æˆ‘å€‘å¦‚ä½•æ‰¾åˆ°<code>g</code>å’Œ<code>g</code>å¦‚ä½•æ‰¾åˆ°ä»–çš„è®Šæ•¸ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">e <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">env</span>()
e<span style="color:#f92672">$</span>g <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>() <span style="color:#ae81ff">1</span></code></pre></div>
<p><img src="../diagrams/environments/binding-2.png" alt="plot of chunk unnamed-chunk-47" /></p>

<h3 id="namespaces">Namespaces</h3>

<p>åœ¨ä¸Šé¢çš„åœ–å½¢ä¸­,æˆ‘å€‘å·²ç¶“çŸ¥é“å¥—ä»¶çš„parentæœƒéš¨è‘—ä¹‹å‰å¥—ä»¶è¼‰å…¥çš„é †åºä¸åŒè€Œä¸åŒã€‚é€™å°±å°è‡´Rç¨‹å¼è¨­è¨ˆè€…å¿…é ˆä¿è­‰å€‹åˆ¥å¥—ä»¶ä¸Šå¦‚æœä½¿ç”¨åˆ¥çš„å¥—ä»¶çš„å‡½æ•¸ï¼Œå¿…é ˆæ˜¯åŸå§‹ç›®çš„çš„é‚£ä¸€å€‹ã€‚<em>namespaces</em> å°±æ˜¯ç‚ºæ­¤ç›®çš„è€Œç”¢ç”Ÿ: æ¯å€‹å¥—ä»¶å¿…é ˆçš„ä½¿ç”¨å¿…é ˆä¸€è‡´,è€Œä¸ç®¡ä½¿ç”¨è€…å¦‚ä½•è¼‰å…¥å¥—ä»¶.</p>

<p>ä»¥ <code>sd()</code>ç‚ºä¾‹å­:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">sd
<span style="color:#75715e">#&gt; function (x, na.rm = FALSE) </span>
<span style="color:#75715e">#&gt; sqrt(var(if (is.vector(x) || is.factor(x)) x else as.double(x), </span>
<span style="color:#75715e">#&gt;     na.rm = na.rm))</span>
<span style="color:#75715e">#&gt; &lt;bytecode: 0x0000000014130b98&gt;</span>
<span style="color:#75715e">#&gt; &lt;environment: namespace:stats&gt;</span></code></pre></div>
<p><code>sd()</code> å¿…é ˆä½¿ç”¨å‡½æ•¸ <code>var()</code>, å› æ­¤é€™å€‹<code>var()</code>åˆ°åº•ä¾†è‡ª global environment,é‚„æ˜¯å…¶ä»–æ¥å…¥(attached)çš„å¥—ä»¶çš„é€™ç¨®å•é¡Œå¿…é ˆé¿å…ã€‚ R avoids this problem by taking advantage of the function vs. binding environment described above.</p>

<p>æ¯å€‹å¥—ä»¶ä¸­çš„å‡½æ•¸å’Œä¸€å°ç’°å¢ƒç‰©ä»¶æœ‰é—œ:å¥—ä»¶ç’°å¢ƒ(ä¹‹å‰å­¸åˆ°çš„)é‚„æœ‰*namespace*ç’°å¢ƒç‰©ä»¶ã€‚</p>

<ul>
<li><p>package environment:  æ˜¯å¥—ä»¶çš„å¤–éƒ¨ä»‹é¢ï¼Œé€™æ˜¯Rä½¿ç”¨è€…å¦‚ä½•åœ¨æ¥å…¥çš„å¥—ä»¶ä¸­å°‹æ‰¾å‡½æ•¸çš„åœ°æ–¹(æˆ–è€…å¯ä»¥åˆ©ç”¨ <code>::</code>) package enviromnent çš„parent ç”±æœå°‹è·¯å¾‘æ±ºå®š(å¯ä»¥åˆ©ç”¨<code>search()</code>çŸ¥é“)æ±ºå®š(ä¹Ÿå°±æ˜¯è¼‰å…¥çš„é †åº)</p></li>

<li><p>namespace environment:æ˜¯å¥—ä»¶çš„å…§éƒ¨ä»‹é¢ã€‚package environment æ§åˆ¶æˆ‘å€‘å¦‚ä½•æ‰¾åˆ°å‡½æ•¸,è€Œnamespace environmentæ§åˆ¶å‡½æ•¸å¦‚ä½•æ‰¾åˆ°è®Šæ•¸ã€‚</p></li>
</ul>

<p>åœ¨package environmentçš„æ¯å€‹ç¹«çµä¹Ÿå¯ä»¥åœ¨namespace environmentä¸­æ‰¾åˆ°ã€‚é€™æ¨£å¯ä»¥ç¢ºä¿æ¯å€‹å‡½æ•¸å¯ä»¥ä½¿ç”¨å¥—ä»¶ä¸­çš„å…¶ä»–å‡½æ•¸ã€‚ä½†æ˜¯æœ‰äº›ç¹«çµåªèƒ½åœ¨namespace ä¸­æ‰¾åˆ°(ä¾‹å¦‚å…§éƒ¨æˆ–éè¼¸å‡ºç‰©ä»¶),é€™ç¨®å…§éƒ¨ç‰©ä»¶é€šå¸¸æ˜¯ç”¨ä¾†éš±è—ä¸€äº›ç¹ç‘£çš„ä¸”ä¸éœ€è¦çµ¦ä½¿ç”¨è€…çœ‹åˆ°çš„ç´°ç¯€ã€‚;</p>

<p><img src="../diagrams/environments/namespace-bind.png" alt="plot of chunk unnamed-chunk-49" /></p>

<p>æ¯å€‹namespace environment æœ‰ä¸€æ¨£çš„ç¥–é›†åˆ:</p>

<ul>
<li><p>æ¯å€‹namespaceæœ‰*imports*çš„ç’°å¢ƒç‰©ä»¶ï¼Œå…¶ä¸­åŒ…å«äº†å¥—ä»¶ä¸­ç”¨åˆ°çš„æ‰€æœ‰å‡½æ•¸ç¹«çµã€‚è€Œæ‰€è¬‚<a href="#imports-environment">è¼¸å…¥ç’°å¢ƒ</a>å¯¦éš›ç”±å¥—è£é–‹ç™¼äººå“¡åœ¨æª”æ¡ˆ<code>NAMESPACE</code>æŒ‡å®š</p></li>

<li><p>æ˜ç¢ºçš„è¼¸å…¥æ¯å€‹<code>base</code>å‡½æ•¸,å¾ˆç¹ç‘£,æ‰€ä»¥Rç›´æ¥è¨­å®š<code>import enviroment</code>çš„parentæ˜¯<code>base *namespae*</code>[^1]ã€‚</p></li>
</ul>


<div class="notices sidebar" >The base namespace contains the same bindings as the base environment, but it has different parent.</div>


<ul>
<li><em>base namespace</em> çš„parentæ˜¯ç¸½é«”ç’°å¢ƒ(#global environment).åƒè€ƒä¸‹åœ–,é€™ç¨®è¨­è¨ˆå°è‡´åœ¨import environmentä¸­æ‰¾ä¸åˆ°ç¹«çµæ™‚,æœƒé–‹å§‹å†ç¸½é«”ç’°å¢ƒä¸­å°‹æ‰¾,è€Œä¹‹å‰æéç¸½é«”ç’°å¢ƒé€šå¸¸æ˜¯äº’å‹•ç’°å¢ƒä¸‹åç¨±æœå°‹çš„é–‹å§‹è·¯å¾‘,é€™ä¹Ÿå°è‡´æœå°‹çš„æ–¹å¼å—åˆ°å¥—ä»¶è¼‰å…¥é †åºçš„å½±éŸ¿ã€‚å› æ­¤,Ræä¾›äº†äº†<code>R CMD check</code>ä¾†è­¦å‘Šæ­¤ç¨®æƒ…æ³çš„ç™¼ç”Ÿã€‚(é›–ç„¶æœ‰éº»ç…©,ä½†æ˜¯ç”±æ–¼S3 æ–¹æ³•çš„dispatch é—œä¿‚,æ­¤ç¨®æ–¹å¼ä»ç„¶ç•™è‘—)<br />
<br />
<br /></li>
</ul>

<p><img src="../diagrams/environments/namespace-env.png" alt="plot of chunk unnamed-chunk-50" /></p>

<p>ç¶œåˆä¸Šè¿°,å¯ä»¥å¾—åˆ°ä¸‹åœ–::</p>

<p><img src="../diagrams/environments/namespace.png" alt="plot of chunk unnamed-chunk-51" /></p>

<p>æ‰€ä»¥ç•¶ <code>sd()</code> æœå°‹<code>var</code> çš„å€¼çš„æ™‚å€™,æœå°‹é †åºæ˜¯å—åˆ°é–‹ç™¼è€…çš„æŒ‡å®š(åœ¨æª”æ¡ˆNAMESPACEåˆ©ç”¨import)ï¼Œè€Œä¸æœƒå—åˆ°å¥—è£ä½¿ç”¨è€…çš„å½±éŸ¿ã€‚é€™æ¨£ä¿è­‰æ¯æ¬¡å¥—ä»¶ç¨‹å¼ç¢¼åŸ·è¡Œçš„æ™‚å€™,éƒ½ä¸€æ¨£,è€Œä¸æœƒå—åˆ°ä¸€èˆ¬ä½¿ç”¨è€…è¼‰å…¥å¥—ä»¶çš„é †åºè€Œå½±éŸ¿ã€‚</p>

<p>æ³¨æ„åœ¨packageå’Œnamespaceå…©ç¨®ç’°å¢ƒä¹‹é–“æ²’æœ‰ç›´æ¥çš„é€£çµ.é€£çµæ˜¯ç”±*å‡½æ•¸ç’°å¢ƒ*å®šç¾©ã€‚</p>

<h3 id="execution-environments">Execution environments</h3>

<p><strong>execution</strong> environment. ä¸‹é¢çš„å‡½æ•¸ç¬¬ä¸€æ¬¡åŸ·è¡Œçš„æ™‚å€™æœƒå‚³å›ç”šéº¼?ç¬¬2æ¬¡å‘¢?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">g <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(x) {
  <span style="color:#a6e22e">if </span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">env_has</span>(<span style="color:#a6e22e">current_env</span>(), <span style="color:#e6db74">&#34;a&#34;</span>)) {
    <span style="color:#a6e22e">message</span>(<span style="color:#e6db74">&#34;Defining a&#34;</span>)
    a <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>
  } else {
    a <span style="color:#f92672">&lt;-</span> a <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
  }
  a
}</code></pre></div>
<p>å†ä¸€æ¬¡åˆ©ç”¨ä¸‹é¢çš„èª¿ç”¨,ç¢ºèªä½ çš„ç­”æ¡ˆ:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">g</span>(<span style="color:#ae81ff">10</span>)
<span style="color:#75715e">#&gt; Defining a</span>
<span style="color:#75715e">#&gt; [1] 1</span>
<span style="color:#a6e22e">g</span>(<span style="color:#ae81ff">10</span>)
<span style="color:#75715e">#&gt; Defining a</span>
<span style="color:#75715e">#&gt; [1] 1</span>
<span style="color:#a6e22e">g</span>(<span style="color:#ae81ff">11</span>)
<span style="color:#75715e">#&gt; Defining a</span>
<span style="color:#75715e">#&gt; [1] 1</span></code></pre></div>
<p>é€™å€‹å‡½æ•¸æ¯æ¬¡åŸ·è¡Œéƒ½å‚³å›ä¸€æ¨£çš„ç­”æ¡ˆ,åƒè€ƒ <a href="#fresh-start">a fresh start</a>. æ¯æ¬¡å‡½æ•¸è¢«èª¿ç”¨çš„æ™‚å€™,ä¸€å€‹æ–°çš„ç’°å¢ƒéƒ½æœƒè¢«å»ºç«‹ä¾†ä¸»å°åŸ·è¡Œã€‚é€™ç¨®ç’°å¢ƒç¨±ç‚º*åŸ·è¡Œç’°å¢ƒ*ã€‚è€Œ*åŸ·è¡Œç’°å¢ƒ*çš„parentç‚º function environment.</p>

<p>ç”¨å¦ä¸€å€‹ç°¡å–®é»çš„ä¾‹å­èªªæ˜.<br />
(åœ–ä¸­,åŸ·è¡Œç’°å¢ƒçš„parenté–“æ¥è¡¨ç¤º:ç¶“ç”±å‡½æ•¸ç’°å¢ƒ).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">h <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(x) {
  <span style="color:#75715e"># 1.</span>
  a <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">2</span> <span style="color:#75715e"># 2.</span>
  x <span style="color:#f92672">+</span> a
}
y <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">h</span>(<span style="color:#ae81ff">1</span>) <span style="color:#75715e"># 3.</span></code></pre></div>
<p><img src="../diagrams/environments/execution.png" alt="plot of chunk unnamed-chunk-55" /></p>

<p>åŸ·è¡Œç’°å¢ƒ(execution environment)çŸ­æš«å­˜åœ¨,ç•¶å‡½æ•¸åŸ·è¡Œå®Œç•¢é€šå¸¸æœƒè¢«GCã€‚åœ¨å¹¾ç¨®æƒ…æ³ä¸‹,æœƒåœ¨è¨˜æ†¶é«”å­˜åœ¨æ¯”è¼ƒä¹…,ç¬¬ä¸€ç¨®æ˜¯å›å‚³çµ¦å¦ä¸€å€‹è®Šæ•¸:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">h2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(x) {
  a <span style="color:#f92672">&lt;-</span> x <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>
  <span style="color:#a6e22e">current_env</span>()
}

e <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">h2</span>(x <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>)
<span style="color:#a6e22e">env_print</span>(e)
<span style="color:#75715e">#&gt; &lt;environment: 000000001DEE1910&gt;</span>
<span style="color:#75715e">#&gt; parent: &lt;environment: global&gt;</span>
<span style="color:#75715e">#&gt; bindings:</span>
<span style="color:#75715e">#&gt;  * a: &lt;dbl&gt;</span>
<span style="color:#75715e">#&gt;  * x: &lt;dbl&gt;</span>
<span style="color:#a6e22e">fn_env</span>(h2)
<span style="color:#75715e">#&gt; &lt;environment: R_GlobalEnv&gt;</span></code></pre></div>
<p>Another way to capture it is to return an object with a binding to that environment, like a function. The following example illustrates that idea with a function factory, <code>plus()</code>. We use that factory to create a function called <code>plus_one()</code>.</p>

<p>There&rsquo;s a lot going on in the diagram because the enclosing environment of <code>plus_one()</code> is the execution environment of <code>plus()</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">plus <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(x) {
  <span style="color:#a6e22e">function</span>(y) x <span style="color:#f92672">+</span> y
}

plus_one <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">plus</span>(<span style="color:#ae81ff">1</span>)
plus_one
<span style="color:#75715e">#&gt; function(y) x + y</span>
<span style="color:#75715e">#&gt; &lt;environment: 0x000000001e269128&gt;</span></code></pre></div>
<p><img src="../diagrams/environments/closure.png" alt="plot of chunk unnamed-chunk-58" /></p>

<p>What happens when we call <code>plus_one()</code>? Its execution environment will have the captured execution environment of <code>plus()</code> as its parent:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">plus_one</span>(<span style="color:#ae81ff">2</span>)
<span style="color:#75715e">#&gt; [1] 3</span></code></pre></div>
<p><img src="../diagrams/environments/closure-call.png" alt="plot of chunk unnamed-chunk-60" /></p>

<p>You&rsquo;ll learn more about function factories in <a href="#functional-programming">functional programming</a>.</p>

<h3 id="exercises-2">Exercises</h3>

<ol>
<li><p>How is <code>search_envs()</code> different to <code>env_parents(global_env())</code>?</p></li>

<li><p>Draw a diagram that shows the enclosing environments of this function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">f1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(x1) {
  f2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(x2) {
    f3 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(x3) {
      x1 <span style="color:#f92672">+</span> x2 <span style="color:#f92672">+</span> x3
    }
    <span style="color:#a6e22e">f3</span>(<span style="color:#ae81ff">3</span>)
  }
  <span style="color:#a6e22e">f2</span>(<span style="color:#ae81ff">2</span>)
}
<span style="color:#a6e22e">f1</span>(<span style="color:#ae81ff">1</span>)</code></pre></div></li>

<li><p>Write an enhanced version of <code>str()</code> that provides more information<br />
about functions. Show where the function was found and what environment<br />
it was defined in.</p></li>
</ol>

<h2 id="the-call-stack">The call stack</h2>

<dl>
<dt>é‚„æœ‰å¦ä¸€ç¨®ç’°å¢ƒç¨±ç‚º <strong>caller</strong> environment, å¯ä»¥ç¶“ç”± <code>rlang::caller_env()</code>å­˜å–ã€‚. This provides the environment from which the function was called, and hence varies based on how the function is called, not how the function was created. As we saw above this is a useful default whenever you write a function that takes an environment as an argument.<br />
<br /></dt>
<dt>::: base<br />
<code>parent.frame()</code> is equivalent to <code>caller_env()</code>; just note that it returns an environment, not a frame.<br />
:::<br />
<br /></dt>
</dl>

<p>To fully understand the caller environment we need to discuss two related concepts: the <strong>call stack</strong>, which is made up of <strong>frames</strong>. Executing a function creates two types of context. You&rsquo;ve learned about one already: the execution environment is a child of the function environment, which is determined by where the function was created. There&rsquo;s another type of context created by where the function was called: this is called the call stack.</p>

<p>There are also a couple of small wrinkles when it comes to custom evaluation. See <a href="#eval-frame">environments vs. frames</a> for more details.</p>

<h3 id="simple-call-stacks">Simple call stacks</h3>

<p>Let&rsquo;s illustrate this with a simple sequence of calls: <code>f()</code> calls <code>g()</code> calls <code>h()</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">f <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(x) {
  <span style="color:#a6e22e">g</span>(x <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
}
g <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(x) {
  <span style="color:#a6e22e">h</span>(x <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>)
}
h <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(x) {
  <span style="color:#a6e22e">stop</span>()
}</code></pre></div>
<p>The way you most commonly see a call stack in R is by looking at the <code>traceback()</code> after an error has occured:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">f</span>(x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)
<span style="color:#75715e">#&gt; Error:</span>
<span style="color:#a6e22e">traceback</span>()
<span style="color:#75715e">#&gt; 4: stop()</span>
<span style="color:#75715e">#&gt; 3: h(x = 3) </span>
<span style="color:#75715e">#&gt; 2: g(x = 2)</span>
<span style="color:#75715e">#&gt; 1: f(x = 1)</span></code></pre></div>
<p>Instead of <code>stop()</code> + <code>traceback()</code> to understand the call stack, we&rsquo;re going to use <code>lobstr::cst()</code> to print out the <strong>c</strong>all <strong>s</strong>tack <strong>t</strong>ree:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">h <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(x) {
  lobstr<span style="color:#f92672">::</span><span style="color:#a6e22e">cst</span>()
}
<span style="color:#a6e22e">f</span>(x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)
<span style="color:#75715e">#&gt; ???</span>
<span style="color:#75715e">#&gt; ??îœ¿?Â€f(x = 1)</span>
<span style="color:#75715e">#&gt;   ??îœ¿?Â€g(x = 2)</span>
<span style="color:#75715e">#&gt;     ??îœ¿?Â€h(x = 3)</span>
<span style="color:#75715e">#&gt;       ??îœ¿?Â€lobstr::cst()</span></code></pre></div>
<p>This shows us that <code>cst()</code> was called from <code>h()</code>, which was called from <code>g()</code>, which was called from <code>f()</code>. Note that the order is the opposite from <code>traceback()</code>. As the call stacks get more compliated, I think it&rsquo;s easier to understand the sequence of calls if you start from the beginning, rather than the end (i.e. <code>f()</code> calls <code>g()</code>; rather than <code>g()</code> was called by <code>f()</code>).</p>

<h3 id="lazy-evaluation">Lazy evaluation</h3>

<p>The call stack above is simple - while you get a hint that there&rsquo;s some tree-like structure involved, everything happens on a single branch. This is typical of a call stack when all arguments are eagerly evaluated.</p>

<p>Let&rsquo;s create a more complicated example that involves some lazy evaluation. We&rsquo;ll create a sequence of functions, <code>a()</code>, <code>b()</code>, <code>c()</code>, that pass along an argument <code>x</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">a <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(x) <span style="color:#a6e22e">b</span>(x)
b <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(x) <span style="color:#a6e22e">c</span>(x)
c <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(x) x

<span style="color:#a6e22e">a</span>(<span style="color:#a6e22e">f</span>())
<span style="color:#75715e">#&gt; ???</span>
<span style="color:#75715e">#&gt; ??î°§?Â€a(f())</span>
<span style="color:#75715e">#&gt; ??? ??îœ¿?Â€b(x)</span>
<span style="color:#75715e">#&gt; ???   ??îœ¿?Â€c(x)</span>
<span style="color:#75715e">#&gt; ??îœ¿?Â€f()</span>
<span style="color:#75715e">#&gt;   ??îœ¿?Â€g(x = 2)</span>
<span style="color:#75715e">#&gt;     ??îœ¿?Â€h(x = 3)</span>
<span style="color:#75715e">#&gt;       ??îœ¿?Â€lobstr::cst()</span></code></pre></div>
<p><code>x</code> is lazily evaluated so this tree gets two branches. In the first branch <code>a()</code> calls <code>b()</code>, then <code>b()</code> calls <code>c()</code>. The second branch starts when <code>c()</code> evaluates its argument <code>x</code>. This argument is evaluated in a new branch because the environment in which it is evaluated is the global environment, not the environment of <code>c()</code>.</p>

<h3 id="frames">Frames</h3>

<p>Each element of the call stack is a <strong>frame</strong><sup class="footnote-ref" id="fnref:frame"><a href="#fn:frame">1</a></sup>, also known as an evaluation context.<br />
The frame is an extremely important internal data structure, and R code can only access a small part of the data structure because it&rsquo;s so critical. A frame has three main components that are accessible from R:</p>

<ul>
<li><p>An expression (labelled with <code>expr</code>) giving the function call. This is<br />
what <code>traceback()</code> prints out.</p></li>

<li><p>An environment (labelled with <code>env</code>), which is typically the execution<br />
environment of a function. There are two main exceptions: the environment of<br />
the global frame is the global environment, and calling <code>eval()</code> also<br />
generates frames, where the environment can be anything.</p></li>

<li><p>A parent, the previous call in the call stack (shown by a grey arrow).</p></li>
</ul>

<p><img src="../diagrams/environments/calling.png" alt="plot of chunk unnamed-chunk-66" /></p>

<p>(To focus on the calling environments, I have omitted the bindings in the global environment from <code>f</code>, <code>g</code>, and <code>h</code> to the respective function objects.)</p>

<p>The frame also holds exit handlers created with <code>on.exit()</code>, restarts and handlers for the condition system, and which context to <code>return()</code> to when a function completes. These are important for the internal operation of R, but are not directly accessible.</p>

<h3 id="dynamic-scope">Dynamic scope</h3>

<p>Looking up variables in the calling stack rather than in the enclosing environment is called <strong>dynamic scoping</strong>. Few languages implement dynamic scoping (Emacs Lisp is a <a href="http://www.gnu.org/software/emacs/emacs-paper.html#SEC15">notable exception</a>.) This is because dynamic scoping makes it much harder to reason about how a function operates: not only do you need to know how it was defined, you also need to know the context in which it was called. Dynamic scoping is primarily useful for developing functions that aid interactive data analysis. It is one of the topics discussed in <a href="#nse">non-standard evaluation</a>.</p>

<h3 id="exercises-3">Exercises</h3>

<ol>
<li>Write a function that lists all the variables defined in the environment<br />
in which it was called. It should return the same results as <code>ls()</code>.<br />
<br /></li>
</ol>

<h2 id="explicit-envs">As data structures</h2>

<p>As well as powering scoping, environments are also useful data structures in their own right because they have reference semantics.  There are three common problems that they can help solve:</p>

<ul>
<li><p><strong>Avoiding copies of large data</strong>. Since environments have reference semantics,<br />
you&rsquo;ll never accidentally create a copy. This makes it a useful vessel for<br />
large objects. Bare environments are not that pleasant to work with;<br />
I recommend using R6 objects instead. Learn more in [R6].</p></li>

<li><p><strong>Managing state within a package</strong>. Explicit environments are useful in<br />
packages because they allow you to maintain state across function calls.<br />
Normally, objects in a package are locked, so you can&rsquo;t modify them<br />
directly. Instead, you can do something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">my_env <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">new.env</span>(parent <span style="color:#f92672">=</span> <span style="color:#a6e22e">emptyenv</span>())
my_env<span style="color:#f92672">$</span>a <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>
    
get_a <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>() {
  my_env<span style="color:#f92672">$</span>a
}
set_a <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(value) {
  old <span style="color:#f92672">&lt;-</span> my_env<span style="color:#f92672">$</span>a
  my_env<span style="color:#f92672">$</span>a <span style="color:#f92672">&lt;-</span> value
  <span style="color:#a6e22e">invisible</span>(old)
}</code></pre></div>
<p>Returning the old value from setter functions is a good pattern because<br />
it makes it easier to reset the previous value in conjunction with<br />
<code>on.exit()</code> (see more in <a href="#on-exit">on exit</a>).</p></li>

<li><p><strong>As a hashmap</strong>. A hashmap is a data structure that takes constant, O(1),<br />
time to find an object based on its name. Environments provide this<br />
behaviour by default, so can be used to simulate a hashmap. See the<br />
CRAN package hash for a complete development of this idea.</p></li>
</ul>

<h2 id="toc_28"><code>&lt;&lt;-</code></h2>

<p>The ancestors of an environment have an important relationship to <code>&lt;&lt;-</code>. The regular assignment arrow, <code>&lt;-</code>, always creates a variable in the current environment. The deep assignment arrow, <code>&lt;&lt;-</code>, never creates a variable in the current environment, but instead modifies an existing variable found by walking up the parent environments.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">x <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">0</span>
f <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>() {
  x <span style="color:#f92672">&lt;&lt;-</span> <span style="color:#ae81ff">1</span>
}
<span style="color:#a6e22e">f</span>()
x
<span style="color:#75715e">#&gt; [1] 1</span></code></pre></div>
<p>If <code>&lt;&lt;-</code> doesn&rsquo;t find an existing variable, it will create one in the global environment. This is usually undesirable, because global variables introduce non-obvious dependencies between functions. <code>&lt;&lt;-</code> is most often used in conjunction with a closure, as described in <a href="#closures">Closures</a>.</p>

<h3 id="exercises-4">Exercises</h3>

<ol>
<li><p>What does this function do? How does it differ from <code>&lt;&lt;-</code> and why<br />
might you prefer it?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">rebind <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(name, value, env <span style="color:#f92672">=</span> <span style="color:#a6e22e">caller_env</span>()) {
  <span style="color:#a6e22e">if </span>(<span style="color:#a6e22e">identical</span>(env, <span style="color:#a6e22e">empty_env</span>())) {
    <span style="color:#a6e22e">stop</span>(<span style="color:#e6db74">&#34;Can&#39;t find `&#34;</span>, name, <span style="color:#e6db74">&#34;`&#34;</span>, call. <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>)
  } else <span style="color:#a6e22e">if </span>(<span style="color:#a6e22e">env_has</span>(env, name)) {
    <span style="color:#a6e22e">env_poke</span>(env, name, value)
  } else {
    <span style="color:#a6e22e">rebind</span>(name, value, <span style="color:#a6e22e">env_parent</span>(env))
  }
}
<span style="color:#a6e22e">rebind</span>(<span style="color:#e6db74">&#34;a&#34;</span>, <span style="color:#ae81ff">10</span>)
<span style="color:#75715e">#&gt; Error: Can&#39;t find `a`</span>
a <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">5</span>
<span style="color:#a6e22e">rebind</span>(<span style="color:#e6db74">&#34;a&#34;</span>, <span style="color:#ae81ff">10</span>)
a
<span style="color:#75715e">#&gt; [1] 10</span></code></pre></div></li>
</ol>

<h2 id="env-answers">Quiz answers</h2>

<ol>
<li><p>There are four ways: every object in an environment must have a name;<br />
order doesn&rsquo;t matter; environments have parents; environments have<br />
reference semantics.</p></li>

<li><p>The parent of the global environment is the last package that you<br />
loaded. The only environment that doesn&rsquo;t have a parent is the empty<br />
environment.</p></li>

<li><p>The enclosing environment of a function is the environment where it<br />
was created. It determines where a function looks for variables.</p></li>

<li><p>Use <code>caller_env()</code> or <code>parent.frame()</code>.</p></li>

<li><p><code>&lt;-</code> always creates a binding in the current environment; <code>&lt;&lt;-</code><br />
rebinds an existing name in a parent of the current environment.</p></li>
</ol>

<h3 id="term">term</h3>

<h5 id="global-environment">global environment :ç¸½é«”ç’°å¢ƒ</h5>

<h5 id="package-environments">package environments</h5>

<h5 id="imports-environment">imports environment</h5>
<div class="footnotes">

<hr />

<ol>
<li id="fn:frame">NB: <code>?environment</code> uses frame in a different sense: &ldquo;Environments consist of a <em>frame</em>, or collection of named objects, and a pointer to an enclosing environment.&ldquo;. We avoid this sense of frame, which comes from S, because it&rsquo;s very specific and not widely used in base R. For example, the &ldquo;frame&rdquo; in <code>parent.frame()</code> is an execution context, not a collection of named objects.<br />
 <a class="footnote-return" href="#fnref:frame"><sup>[return]</sup></a></li>
</ol>
</div>


<footer class="footline">
	
</footer>

        
        </div>
        
rlang\Environments.md
      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="../rlang/plot02.html" title="Plot more"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="../rlang/sampling.html" title="sampling" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="../js/clipboard.min.js?1608182905"></script>
    <script src="../js/perfect-scrollbar.min.js?1608182905"></script>
    <script src="../js/perfect-scrollbar.jquery.min.js?1608182905"></script>
    <script src="../js/jquery.sticky.js?1608182905"></script>
    <script src="../js/featherlight.min.js?1608182905"></script>
    <script src="../js/highlight.pack.js?1608182905"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="../js/modernizr.custom-3.6.0.js?1608182905"></script>
    <script src="../js/learn.js?1608182905"></script>
    <script src="../js/hugo-learn.js?1608182905"></script>
    
        
            <script src="../mermaid/mermaid.js?1608182905"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    



  </body>
</html>

