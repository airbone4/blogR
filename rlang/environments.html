<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.76.5" />
    <meta name="description" content="進階">


    <link rel="shortcut icon" href="../images/favicon.png" type="image/x-icon" />
<link rel="icon" href="../images/favicon.png" type="image/x-icon" />

    <title>Environment - R in Class</title>

    
    <link href="../css/nucleus.css?1604543915" rel="stylesheet">
    <link href="../css/fontawesome-all.min.css?1604543915" rel="stylesheet">
    <link href="../css/hybrid.css?1604543915" rel="stylesheet">
    <link href="../css/featherlight.min.css?1604543915" rel="stylesheet">
    <link href="../css/perfect-scrollbar.min.css?1604543915" rel="stylesheet">
    <link href="../css/auto-complete.css?1604543915" rel="stylesheet">
    <link href="../css/atom-one-dark-reasonable.css?1604543915" rel="stylesheet">
    <link href="../css/theme.css?1604543915" rel="stylesheet">
    <link href="../css/hugo-theme.css?1604543915" rel="stylesheet">
    
    <link href="../extra_theme/css/mystyle.css?1604543915" rel="stylesheet"><link href="../extra_theme/css/demoContainer.css?1604543915" rel="stylesheet"><link href="../extra_theme/css/rmd.css?1604543915" rel="stylesheet">

    <script src="../js/jquery-3.3.1.min.js?1604543915"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="../rlang/environments.html">

    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="https://airbon5.github.io/xx/">
  <img src=../extra_theme/images/rmi.png>
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="../js/lunr.min.js?1604543915"></script>
<script type="text/javascript" src="../js/auto-complete.js?1604543915"></script>
<script type="text/javascript">
    
        var baseurl = "\/";
    
</script>
<script type="text/javascript" src="../js/search.js?1604543915"></script>

    
  </div>
  
    <section id="homelinks">
      <ul>
        <li>
            <a class="padding" href='../'><i class='fas fa-home'></i> Home</a>
        </li>
      </ul>
    </section>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/rlang.html" title="R language" class="dd-item
        parent
        
        
        ">
      <a href="../rlang.html">
          R language
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/rlang/requirement.html" title="Requirement" class="dd-item ">
        <a href="../rlang/requirement.html">
        Requirement
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/data_explorer_1.html" title="data explorer 1" class="dd-item ">
        <a href="../rlang/data_explorer_1.html">
        data explorer 1
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/data_explorer_2.html" title="data explorer 2" class="dd-item ">
        <a href="../rlang/data_explorer_2.html">
        data explorer 2
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/quickview1.html" title="Quick view 1" class="dd-item ">
        <a href="../rlang/quickview1.html">
        Quick view 1
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/regular_expression.html" title="Regular expression syntax" class="dd-item ">
        <a href="../rlang/regular_expression.html">
        Regular expression syntax
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/topic_dataframe.html" title="topic data frame" class="dd-item ">
        <a href="../rlang/topic_dataframe.html">
        topic data frame
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/type_basic.html" title="type basic" class="dd-item ">
        <a href="../rlang/type_basic.html">
        type basic
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/type_list.html" title="type list" class="dd-item ">
        <a href="../rlang/type_list.html">
        type list
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/type_matrix.html" title="type matrix" class="dd-item ">
        <a href="../rlang/type_matrix.html">
        type matrix
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/type_more.html" title="type more" class="dd-item ">
        <a href="../rlang/type_more.html">
        type more
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/type_post.html" title="type post" class="dd-item ">
        <a href="../rlang/type_post.html">
        type post
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/type_string_function.html" title="type string" class="dd-item ">
        <a href="../rlang/type_string_function.html">
        type string
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/type_vector.html" title="type vector" class="dd-item ">
        <a href="../rlang/type_vector.html">
        type vector
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/filesystem.html" title="File System" class="dd-item ">
        <a href="../rlang/filesystem.html">
        File System
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/objectbasic.html" title="object_basic" class="dd-item ">
        <a href="../rlang/objectbasic.html">
        object_basic
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/programming_1.html" title="Programming 1" class="dd-item ">
        <a href="../rlang/programming_1.html">
        Programming 1
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/r_function.html" title="Function" class="dd-item ">
        <a href="../rlang/r_function.html">
        Function
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/apply_family.html" title="function - apply family" class="dd-item ">
        <a href="../rlang/apply_family.html">
        function - apply family
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/rpackages.html" title="R Package" class="dd-item ">
        <a href="../rlang/rpackages.html">
        R Package
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/plot01.html" title="Plot 01" class="dd-item ">
        <a href="../rlang/plot01.html">
        Plot 01
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/tidybasic01.html" title="TidyBasic01" class="dd-item ">
        <a href="../rlang/tidybasic01.html">
        TidyBasic01
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/plot02.html" title="更多繪圖" class="dd-item ">
        <a href="../rlang/plot02.html">
        更多繪圖
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/environments.html" title="Environment" class="dd-item active">
        <a href="../rlang/environments.html">
        Environment
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/sampling.html" title="sampling" class="dd-item ">
        <a href="../rlang/sampling.html">
        sampling
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/eco_01_intro.html" title="Econometrics" class="dd-item ">
        <a href="../rlang/eco_01_intro.html">
        Econometrics
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/sim_1.html" title="simulation 1" class="dd-item ">
        <a href="../rlang/sim_1.html">
        simulation 1
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/rlang/function.html" title="Functions" class="dd-item ">
        <a href="../rlang/function.html">
        Functions
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/topic.html" title="Topics" class="dd-item
        
        
        
        ">
      <a href="../topic.html">
          Topics
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/topic/rmd/rmd_basic.html" title="Rmd basic" class="dd-item ">
        <a href="../topic/rmd/rmd_basic.html">
        Rmd basic
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/topic/rmd/rmd_topic_1.html" title="rmd topic 1" class="dd-item ">
        <a href="../topic/rmd/rmd_topic_1.html">
        rmd topic 1
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/topic/rmd/git-book-note.html" title="git book note" class="dd-item ">
        <a href="../topic/rmd/git-book-note.html">
        git book note
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/topic/rmd/rmd_pdf.html" title="Rmd pdf" class="dd-item ">
        <a href="../topic/rmd/rmd_pdf.html">
        Rmd pdf
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/topic/sitetecnote/git-note.html" title="git-note" class="dd-item ">
        <a href="../topic/sitetecnote/git-note.html">
        git-note
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/topic/interesting.html" title="interesting" class="dd-item ">
        <a href="../topic/interesting.html">
        interesting
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/topic/experiment.html" title="實驗" class="dd-item
        
        
        
        ">
      <a href="../topic/experiment.html">
          實驗
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/topic/experiment/central.html" title="中央" class="dd-item ">
        <a href="../topic/experiment/central.html">
        中央
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/topic/test.html" title="網頁測試" class="dd-item
        
        
        
        ">
      <a href="../topic/test.html">
          網頁測試
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/topic/test/emo_test.html" title="emoji_test" class="dd-item ">
        <a href="../topic/test/emo_test.html">
        emoji_test
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/topic/test/testpage.html" title="testpage" class="dd-item ">
        <a href="../topic/test/testpage.html">
        testpage
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='../'>test for class</a> > <a href='../rlang.html'>R language</a> > Environment
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">

    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Environment

            </h1>
			
          

        



<script src="../rmarkdown-libs/header-attrs/header-attrs.js"></script>
<link href="../rmarkdown-libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="../rmarkdown-libs/anchor-sections/anchor-sections.js"></script>


<div id="environments" class="section level1">
<h1>Environments</h1>
<p>參考
<a href="https://holtzy.github.io/Pimp-my-rmd/" class="uri">https://holtzy.github.io/Pimp-my-rmd/</a></p>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>The environment is the data structure that powers scoping. 相關概念:lexical scoping, namespaces, and R6 classes。</p>
<p>這個文件需要</p>
<pre class="r"><code>devtools::install_github(&quot;tidyverse/rlang&quot;)</code></pre>
<div id="quiz" class="section level3 unnumbered">
<h3>Quiz</h3>
<p>If you can answer the following questions correctly, you already know the most important topics in this chapter. You can find the answers at the end of the chapter in <a href="#env-answers">answers</a>.</p>
<ol style="list-style-type: decimal">
<li><p>List at least three ways that an environment is different to a list.</p></li>
<li><p>What is the parent of the global environment? What is the only
environment that doesn’t have a parent?</p></li>
<li><p>What is the enclosing environment of a function? Why is it
important?</p></li>
<li><p>How do you determine the environment from which a function was called?</p></li>
<li><p>How are <code>&lt;-</code> and <code>&lt;&lt;-</code> different?</p></li>
</ol>
</div>
<div id="outline" class="section level3 unnumbered">
<h3>Outline</h3>
<ul>
<li><p><a href="#env-basics">Environment basics</a> introduces you to the basic properties
of an environment and shows you how to create your own.</p></li>
<li><p><a href="#env-recursion">Recursing over environments</a> provides a function template
for computing with environments, illustrating the idea with a useful
function.</p></li>
<li><p><a href="#explicit-envs">Explicit environments</a> briefly discusses three places where
environments are useful data structures for solving other problems.</p></li>
</ul>
</div>
<div id="prerequisites" class="section level3 unnumbered">
<h3>Prerequisites</h3>
<p>這個章節利用了套件<code>rlang</code>裡的函數，來探索環境物件。</p>
<p>在<code>rlang</code>套件中,<code>env_</code>函數是設計用來和pipe一起工作的,這裡不深入。</p>
<div class="sidebar">
<p><code>global_env()</code>和<code>globalenv()</code>的執行結果一樣。</p>
<pre class="r"><code>.GlobalEnv</code></pre>
<pre class="rchunk output"><code>&lt;environment: R_GlobalEnv&gt;</code></pre>
<pre class="r"><code>globalenv()</code></pre>
<pre class="rchunk output"><code>&lt;environment: R_GlobalEnv&gt;</code></pre>
<pre class="r"><code>global_env()</code></pre>
<pre class="rchunk output"><code>&lt;environment: R_GlobalEnv&gt;</code></pre>
<pre class="r"><code>.BaseNamespaceEnv</code></pre>
<pre class="rchunk output"><code>&lt;environment: namespace:base&gt;</code></pre>
<pre class="r"><code>current_env() #</code></pre>
<pre class="rchunk output"><code>&lt;environment: R_GlobalEnv&gt;</code></pre>
</div>
</div>
</div>
<div id="env-basics" class="section level2">
<h2>Environment basics</h2>
<p>基本上一個 environment 類似名稱串列(named list),但是有4個例外:</p>
<ul>
<li>名稱唯一(就是變數唯一)<br />
</li>
<li>名稱沒有順序關係<br />
</li>
<li>會有一個parent<br />
</li>
<li>當改變的時候,不會自動複製 (Environments are not copied when modified).</li>
</ul>
<p>分別探索上面四點:</p>
<div id="basics" class="section level3">
<h3>Basics</h3>
<p>要建立environment, 使用 <code>rlang::env()</code>. 類似使用<code>list()</code>,也是一組名稱-值的配對。:</p>
<pre class="r"><code>e1 &lt;- env(
  a = FALSE,
  b = &quot;a&quot;,
  c = 2.3,
  d = 1:3
)</code></pre>
<div class="base">
<p>建立environment物件,利用函數 <code>new.env()</code> 不用管參數 <code>hash</code> 和 <code>size</code>。注意不能利用<code>$&lt;-</code>同時定義和建立 parameters; 例如,
e1 &lt;- env( ** a &lt;- FALSE ** ) # error
.</p>
</div>
<p>environment物件可以想成是一個袋子,或是names集合。因為沒有次序關係</p>
<p><img src="diagrams/environments/bindings.png" style="display:inline-block;width:80%" /></p>
<p>就像在 <a href="#env-modify">names and values</a>, 討論的,這個物件是參考為基礎.(in C concept) 不會有copy on modifying。而且,環境物件可以自己指向自己(recursion)</p>
<pre class="r"><code>e1$d &lt;- e1</code></pre>
<p><img src="diagrams/environments/loop.png" style="display:inline-block;width:80%" /></p>
<p>沒有指派的環境變數,只會顯示記憶體位址:</p>
<pre class="r"><code>e1</code></pre>
<pre class="rchunk output"><code>&lt;environment: 0x00000000165f64a8&gt;</code></pre>
<p>要知道內容可以使用 <code>env_print()</code> :</p>
<pre class="r"><code>env_print(e1)</code></pre>
<pre class="rchunk output"><code>&lt;environment: 00000000165F64A8&gt;
parent: &lt;environment: global&gt;
bindings:
 * a: &lt;lgl&gt;
 * b: &lt;chr&gt;
 * c: &lt;dbl&gt;
 * d: &lt;env&gt;</code></pre>
<p>想要知道目前有哪些binding(名稱-值 配對)可以利用 <code>env_names()</code></p>
<pre class="r"><code>env_names(e1)</code></pre>
<pre class="rchunk output"><code>[1] &quot;a&quot; &quot;b&quot; &quot;c&quot; &quot;d&quot;</code></pre>
<div class="base">
<p>要列出環境下的繫結，在R 3.2.0 以上,可以使用函數<code>names()</code> ,之前的版本則是 <code>ls()</code>, 但是要注意的是ls 的參數 <code>all.names</code> 內設是 <code>FALSE</code> 因此<code>.</code>開頭的看不到。.</p>
</div>
</div>
<div id="important-environments" class="section level3">
<h3>Important environments</h3>
<p>另外參考 <a href="#function-envs">Special environments</a>。
<code>current_env()</code> 可以知道目前程式碼的執行環境。例如,當我們互動執行RCODE的時候,環境通常是 <a href="#global%20environment">總體環境</a>,或者由函數<code>global_env()</code>可以得到。這個總體環境有時候就叫“workspace”，同時,這也是函數外面所有互動計算發生的地方。
環境物件的比較不能用<code>==</code>,只能用函數<code>identical()</code>。</p>
<pre class="r"><code>identical(global_env(), current_env())</code></pre>
<pre class="rchunk output"><code>[1] TRUE</code></pre>
<pre class="r"><code>global_env() == current_env()</code></pre>
<pre><code>Error in global_env() == current_env():
  只有基元或串列類型才能做比較 (1)</code></pre>
<div class="base">
<ul>
<li><code>globalenv()</code> 和<code>.GlobalEnv</code>: 拿到global environmentand。</li>
<li><code>environment()</code>:拿到目前的環境</li>
</ul>
<p>global environment 的名稱為 <code>R_GlobalEnv</code> 。</p>
<pre class="r"><code>global_env()</code></pre>
<pre class="rchunk output"><code>&lt;environment: R_GlobalEnv&gt;</code></pre>
<pre class="r"><code>current_env()</code></pre>
<pre class="rchunk output"><code>&lt;environment: R_GlobalEnv&gt;</code></pre>
<pre class="r"><code>.GlobalEnv</code></pre>
<pre class="rchunk output"><code>&lt;environment: R_GlobalEnv&gt;</code></pre>
</div>
</div>
<div id="parents" class="section level3">
<h3>Parents</h3>
<p>每一個環境物件都有一個<em>parent</em>。<em>parent</em> 也一個環境物件。在方塊圖中,parent以藍色圈表示,並用箭頭指向另一個環境物件。</p>
<p>這個parent用來建立 lexical scoping: 如果name沒有在某個環境物件找到,R會重複的在parent中找。
函數<code>env()</code>可以用來建立一個沒有名字的環境
You can set the parent environment by supplying an unnamed argument to <code>env()</code>. If you don’t supply it, it defaults to the current environment.</p>
<pre class="r"><code>e2a &lt;- env(d = 4, e = 5)
e2b &lt;- env(e2a, a = 1, b = 2, c = 3)</code></pre>
<p><img src="diagrams/environments/parents.png" style="display:inline-block;width:80%" /></p>
<p>函數 <code>env_parent()</code>可以用來找出某個環境物件的parent:</p>
<pre class="r"><code>env_parent(e2b)</code></pre>
<pre class="rchunk output"><code>&lt;environment: 0x000000001588cad0&gt;</code></pre>
<pre class="r"><code>env_parent(e2a)</code></pre>
<pre class="rchunk output"><code>&lt;environment: R_GlobalEnv&gt;</code></pre>
<div class="base">
<p>parent.env() === env_parent()</p>
</div>
<p>所有的環境物件中只有一個名稱為<code>R_EmptyEnv</code>的物件沒有parent(用空心藍色表示):</p>
<pre class="r"><code>e2c &lt;- env(empty_env(), d = 4, e = 5)
e2d &lt;- env(e2c, a = 1, b = 2, c = 3)</code></pre>
<p><img src="diagrams/environments/parents-empty.png" style="display:inline-block;width:80%" /></p>
<div class="base">
<p>emptyenv() === empty_env()</p>
</div>
<p>試圖利用函數<code>env_parent()</code>找空環境物件的parent會發生錯誤:</p>
<pre class="r"><code>env_parent(empty_env())</code></pre>
<pre><code>Error: The empty environment has no parent</code></pre>
<p>函數 <code>env_parents()</code>可以找出目前環境物件的所有祖先:這個函數會繼續直到遇上global environment 或是空環境物件。上述過程可以利用<code>last</code>環境物件控制。</p>
<pre class="r"><code>env_parents(e2b)</code></pre>
<pre class="rchunk output"><code>[[1]]   &lt;env: 000000001588CAD0&gt;
[[2]] $ &lt;env: global&gt;</code></pre>
<pre class="r"><code>env_parents(e2d)</code></pre>
<pre class="rchunk output"><code>[[1]]   &lt;env: 000000001475CBC0&gt;
[[2]] $ &lt;env: empty&gt;</code></pre>
<div class="base">
<p>可以利用Use <code>parent.env()</code> 找到環境的parent，但是base中沒有可以找出所有祖先的函數。</p>
</div>
</div>
<div id="getting-and-setting" class="section level3">
<h3>Getting and setting</h3>
<p>存取環境中元素的方法和list類似:使用 <code>$</code> 和 <code>[[</code>:</p>
<pre class="r"><code>e3 &lt;- env(x = 1, y = 2)
e3$x</code></pre>
<pre class="rchunk output"><code>[1] 1</code></pre>
<pre class="r"><code>e3$z &lt;- 3
e3[[&quot;z&quot;]]</code></pre>
<pre class="rchunk output"><code>[1] 3</code></pre>
<p>但是不能使用 <code>[[</code> +數字索引,也不能單獨使用 <code>[</code>:</p>
<pre class="r"><code>e3[[1]]</code></pre>
<pre><code>Error in e3[[1]]:
  取子集環境時的引數不正確</code></pre>
<pre class="r"><code>e3[c(&quot;x&quot;, &quot;y&quot;)]</code></pre>
<pre><code>Error in e3[c(&quot;x&quot;, &quot;y&quot;)]:
  &#39;environment&#39; 類型的物件無法具有子集合</code></pre>
<p>當環境中的繫結不存在時(簡單點,就是變數不存在時)<code>$</code> 和 <code>[[</code> 會傳回 <code>NULL</code> 但不會引發錯誤,如果要有錯誤警告,則利用 <code>env_get()</code> :</p>
<pre class="r"><code>e3$xyz</code></pre>
<pre class="rchunk output"><code>NULL</code></pre>
<pre class="r"><code>env_get(e3, &quot;xyz&quot;)</code></pre>
<pre><code>Error in env_get(e3, &quot;xyz&quot;):
  缺少引數 &quot;default&quot;，也沒有預設值</code></pre>
<p>當繫結不存在,但是想要有預設值傳回時,可以利用參數 <code>default</code> .</p>
<pre class="r"><code>env_get(e3, &quot;xyz&quot;, default = NA)</code></pre>
<pre class="rchunk output"><code>[1] NA</code></pre>
<p>另有兩種方式可以在環境物件加入繫結:</p>
<ul>
<li><p><code>env_poke()</code><a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> takes a name (as string) and a value:</p>
<pre class="r"><code>env_poke(e3, &quot;a&quot;, 100)
e3$a</code></pre>
<pre class="rchunk output"><code>[1] 100</code></pre></li>
<li><p><code>env_bind()</code> allows you to bind multiple values:</p>
<pre class="r"><code>env_bind(e3, a = 10, b = 20)
env_names(e3)</code></pre>
<pre class="rchunk output"><code>[1] &quot;x&quot; &quot;y&quot; &quot;z&quot; &quot;a&quot; &quot;b&quot;</code></pre></li>
</ul>
<p><code>env_has()</code>: 是否環境中有繫結</p>
<pre class="r"><code>env_has(e3, &quot;a&quot;)</code></pre>
<pre class="rchunk output"><code>   a 
TRUE </code></pre>
<p>不能像是list中刪除元素的方式(指派<code>NULL</code>給元素)，而必須使用 <code>env_unbind()</code>:</p>
<pre class="r"><code>e3$a &lt;- NULL
env_has(e3, &quot;a&quot;)</code></pre>
<pre class="rchunk output"><code>   a 
TRUE </code></pre>
<pre class="r"><code>env_unbind(e3, &quot;a&quot;)
env_has(e3, &quot;a&quot;)</code></pre>
<pre class="rchunk output"><code>    a 
FALSE </code></pre>
<p>從一個物件Unbinding 解除名稱，並不會刪除物件，是否刪除物件是 garbage collector的工作.。可以參考 <a href="#gc">GC</a>.</p>
<div class="base">
<p>See <code>get()</code>, <code>assign()</code>, <code>exists()</code>, and <code>rm()</code>. These are designed interactively for use with the current environment, so working with other environments is a little clunky. Also beware the <code>inherits</code> argument: it defaults to <code>TRUE</code> meaning that the base equivalents will inspect the supplied environment and all its ancestors.</p>
</div>
</div>
<div id="finalisers" class="section level3">
<h3>Finalisers</h3>
<p><span class="todo">Add something once rlang has an API. Also mention in data structures below</span></p>
</div>
<div id="advanced-bindings" class="section level3">
<h3>Advanced bindings</h3>
<p>There are two more exotic variants of <code>env_bind()</code>:</p>
<ul>
<li><p><code>env_bind_exprs()</code> creates <strong>delayed bindings</strong>, which are evaluated the
first time they are accessed. Behind the scenes, delayed bindings create
promises, so behave in the same way as function arguments.</p>
<pre class="r"><code>env_bind_exprs(current_env(), b = {Sys.sleep(1); 1})</code></pre>
<pre><code>Warning: `env_bind_exprs()` is deprecated as of rlang 0.3.0.
Please use `env_bind_lazy()` instead.
This warning is displayed once per session.</code></pre>
<pre class="r"><code>system.time(print(b))</code></pre>
<pre class="rchunk output"><code>[1] 1</code></pre>
<pre class="rchunk output"><code>   user  system elapsed 
      0       0       1 </code></pre>
<pre class="r"><code>system.time(print(b))</code></pre>
<pre class="rchunk output"><code>[1] 1</code></pre>
<pre class="rchunk output"><code>   user  system elapsed 
      0       0       0 </code></pre>
<p>Delayed bindings are used to implement <code>autoload()</code>, which makes R behave
as if the package data is in memory, even though it’s only loaded from
disk when you ask for it.</p></li>
<li><p><code>env_bind_fns()</code> creates <strong>active bindings</strong> which are re-computed every
time they’re accessed:</p>
<pre class="r"><code>env_bind_fns(current_env(), z1 = function(val) runif(1))</code></pre>
<pre><code>Warning: `env_bind_fns()` is deprecated as of rlang 0.3.0.
Please use `env_bind_active()` instead.
This warning is displayed once per session.</code></pre>
<pre class="r"><code>z1</code></pre>
<pre class="rchunk output"><code>[1] 0.0808</code></pre>
<pre class="r"><code>z1</code></pre>
<pre class="rchunk output"><code>[1] 0.834</code></pre>
<p>The argument to the function allows you to also override behaviour when
the variable is set:</p>
<pre class="r"><code>env_bind_fns(current_env(), z2 = function(val) {
  if (missing(val)) {
    2
  } else {
     stop(&quot;Don&#39;t touch z2!&quot;, call. = FALSE)
  }
})

z2</code></pre>
<pre class="rchunk output"><code>[1] 2</code></pre>
<pre class="r"><code>z2 &lt;- 3</code></pre>
<pre><code>Error: Don&#39;t touch z2!</code></pre></li>
</ul>
<div class="base">
<p>See <code>?delayedAssign()</code> and <code>?makeActiveBinding()</code>.</p>
</div>
</div>
<div id="exercises" class="section level3">
<h3>Exercises</h3>
<ol style="list-style-type: decimal">
<li><p>List three ways in which an environment differs from a list.</p></li>
<li><p>Create an environment as illustrated by this picture.</p>
<p><img src="diagrams/environments/recursive-1.png" style="display:inline-block;width:80%" /></p></li>
<li><p>Create a pair of environments as illustrated by this picture.</p>
<p><img src="diagrams/environments/recursive-2.png" style="display:inline-block;width:80%" /></p></li>
<li><p>Explain why <code>e[[1]]</code> and <code>e[c("a", "b")]</code> don’t make sense when <code>e</code> is
an environment.</p></li>
<li><p>Create a version of <code>env_poke()</code> that will only bind new names, never
re-bind old names. Some programming languages only do this, and are known
as <a href="http://en.wikipedia.org/wiki/Assignment_(computer_science)#Single_assignment">single assignment languages</a>.</p></li>
</ol>
</div>
</div>
<div id="env-recursion" class="section level2">
<h2>Recursing over environments</h2>
<p>If you want to operate on every ancestor of an environment, it’s often convenient to write a recursive function. This section shows you how, applying your new knowledge of environments to write a function that given a name, finds the environment <code>where()</code> that name is defined, using R’s regular scoping rules.</p>
<p>The definition of <code>where()</code> is straightforward. It has two arguments: the name to look for (as a string), and the environment in which to start the search. (We’ll learn why <code>caller_env()</code> is a good default in <a href="#calling-environments">calling environments</a>.)</p>
<pre class="r"><code>where &lt;- function(name, env = caller_env()) {
  if (identical(env, empty_env())) {
    # Base case
    stop(&quot;Can&#39;t find &quot;, name, call. = FALSE)
  } else if (env_has(env, name)) {
    # Success case
    env
  } else {
    # Recursive case
    where(name, env_parent(env))
  }
}</code></pre>
<p>3個情況:</p>
<ul>
<li><p>The base case: 到達empty environment 沒有parent無法繼續,所以丟出error.</p></li>
<li><p>The successful case: 在env中找到name ，成功,所以傳回env。.</p></li>
<li><p>The recursive case: 在env中找不到,繼續在parent中找。.</p></li>
</ul>
<p>These three cases are illustrated with these three examples:</p>
<pre class="r"><code>where(&quot;yyy&quot;)</code></pre>
<pre><code>Error: Can&#39;t find yyy</code></pre>
<pre class="r"><code>x &lt;- 5
where(&quot;x&quot;)</code></pre>
<pre class="rchunk output"><code>&lt;environment: R_GlobalEnv&gt;</code></pre>
<pre class="r"><code>where(&quot;mean&quot;)</code></pre>
<pre class="rchunk output"><code>&lt;environment: base&gt;</code></pre>
<p>想像有兩個環境物件(如圖):</p>
<pre class="r"><code>e4a &lt;- env(empty_env(), a = 1, b = 2)
e4b &lt;- env(e4a, x = 10, a = 11)</code></pre>
<p><img src="diagrams/environments/where-ex.png" style="display:inline-block;width:80%" /></p>
<ul>
<li><p><code>where(a, e4a)</code> will find <code>a</code> in <code>e4a</code>.</p></li>
<li><p><code>where("b", e4a)</code> doesn’t find <code>b</code> in <code>e4a</code>, so it looks in its parent, <code>e4b</code>,
and finds it there.</p></li>
<li><p><code>where("c", e4a)</code> looks in <code>e4a</code>, then <code>e4b</code>, then hits the empty environment
and throws an error.</p></li>
</ul>
<p>It’s natural to work with environments recursively, so <code>where()</code> provides a useful template. Removing the specifics of <code>where()</code> shows the structure more clearly:</p>
<pre class="r"><code>f &lt;- function(..., env = caller_env()) {
  if (identical(env, empty_env())) {
    # base case
  } else if (success) {
    # success case
  } else {
    # recursive case
    f(..., env = env_parent(env))
  }
}</code></pre>
<div id="iteration-vs-recursion" class="section level3 unnumbered sidebar">
<h3>Iteration vs recursion</h3>
<p>也可以用迭代的方式</p>
<pre class="r"><code>f2 &lt;- function(..., env = caller_env()) {
  while (!identical(env, empty_env())) {
    if (success) {
      # success case
      return()
    }
    # inspect parent
    env &lt;- env_parent(env)
  }

  # base case
}</code></pre>
</div>
<div id="exercises-1" class="section level3">
<h3>Exercises</h3>
<ol style="list-style-type: decimal">
<li><p>Modify <code>where()</code> to return <em>all</em> environments that contain a binding for
<code>name</code>. Carefully think through what type of object the function will
need to return.</p></li>
<li><p>Write a function called <code>fget()</code> that finds only function objects. It
should have two arguments, <code>name</code> and <code>env</code>, and should obey the regular
scoping rules for functions: if there’s an object with a matching name
that’s not a function, look in the parent. For an added challenge, also
add an <code>inherits</code> argument which controls whether the function recurses up
the parents or only looks in one environment.</p></li>
</ol>
</div>
</div>
<div id="function-envs" class="section level2">
<h2>Special environments</h2>
<p>這裡討論 package environments. 然後探討當函數建立時,綁入函數的函數環境。還有當函數被呼叫時的執行環境(ephemeral)。</p>
<p><a href="package-environments">套裝環境</a>主要是看這些環境如何支援namespaces。同時,namespace讓package每次載入的時候,都有一樣的行為,而不售其他packages載入先後的影響。</p>
<div id="package-environments-and-the-search-path" class="section level3">
<h3>Package environments and the search path</h3>
<p>每個套件經由<code>library()</code> 或 <code>require()</code> 接入成為<a href="#global-environment">總體環境</a>的parent。而最後一個<a href="#attach">接入</a>的套件,則是總體環境的第一個parent:</p>
<div class="sidebar">
<p>load 和 attach不一樣，當我們使用library的時候,我們做的是[^attach] 在環境串列中加入我們利用library載入的物件..
[^attach]: Note the difference between attached and loaded. A package is loaded automatically if you access one of its functions using <code>::</code>; it is only <strong>attached</strong> to the search path by <code>library()</code> or <code>require()</code>.</p>
</div>
<pre class="r"><code>env_parent(global_env())</code></pre>
<pre class="rchunk output"><code>&lt;environment: package:rlang&gt;
attr(,&quot;name&quot;)
[1] &quot;package:rlang&quot;
attr(,&quot;path&quot;)
[1] &quot;C:/Program Files/R/R-4.0.2/library/rlang&quot;</code></pre>
<p>And the parent of that package is the second to last package you attached:</p>
<pre class="r"><code>env_parent(env_parent(global_env()))</code></pre>
<pre class="rchunk output"><code>&lt;environment: package:stats&gt;
attr(,&quot;name&quot;)
[1] &quot;package:stats&quot;
attr(,&quot;path&quot;)
[1] &quot;C:/Program Files/R/R-4.0.2/library/stats&quot;</code></pre>
<p>如果一層一層parent回朔,就可以到每個套件被接入的順序,這也是R執行中會用到的 <strong>search path</strong> 因為這些環境的所有物件都可以經由 top-level interactive workspace找到。</p>
<pre class="r"><code>search_envs()</code></pre>
<pre class="rchunk output"><code> [[1]] $ &lt;env: global&gt;
 [[2]] $ &lt;env: package:rlang&gt;
 [[3]] $ &lt;env: package:stats&gt;
 [[4]] $ &lt;env: package:graphics&gt;
 [[5]] $ &lt;env: package:grDevices&gt;
 [[6]] $ &lt;env: package:utils&gt;
 [[7]] $ &lt;env: package:datasets&gt;
 [[8]] $ &lt;env: package:methods&gt;
 [[9]] $ &lt;env: Autoloads&gt;
[[10]] $ &lt;env: package:base&gt;</code></pre>
<div class="base">
<p>函數 <code>search()</code>可以找出環境物件的名稱。</p>
</div>
<p>最後兩個環境物件都一樣:</p>
<ul>
<li><p><code>Autoloads</code> 環境物件,利用 delayed bindings來節省記憶體，也就是在需要的時候才載入(loading)package中的物件(例如大型資料集)。</p></li>
<li><p>base environment, <code>package:base</code> 或簡稱 <code>base</code>, 是base 套裝的環境物件。用來 載入其他套裝(bootstrap)。利用函數 <code>base_env()</code>存取.</p></li>
</ul>
<p>利用圖型表示:</p>
<p><img src="diagrams/environments/search-path.png" style="display:inline-block;width:80%" /></p>
<p>當利用 <code>library()</code> attach其他套件的時候, 總體環境的parent馬上改變:</p>
<p><img src="diagrams/environments/search-path-2.png" style="display:inline-block;width:80%" /></p>
</div>
<div id="the-function-environment" class="section level3">
<h3>The function environment</h3>
<p>當函數被建立的時候,現有的環境會被繫結。稱為<em>function environment</em>, 主要用來支援lexical scoping. 在電腦語言中,當函數紀錄它們的運作環境時,我們說這個函數屬於 <em>closures</em>。,這也是為甚麼這個字眼經常在R語言中出現。.</p>
<p>利用函數 <code>fn_env()</code>可以得到函數的環境物件:</p>
<pre class="r"><code>y &lt;- 1
f &lt;- function(x) x + y
fn_env(f)</code></pre>
<pre class="rchunk output"><code>&lt;environment: R_GlobalEnv&gt;</code></pre>
<div class="base">
<p>一樣利用函數 <code>environment(f)</code> 可以找到函數 <code>f</code>的環境.</p>
</div>
<p>在圖形中,函數被畫成類似子彈,而彈頭的部分繫結環境。</p>
<p><img src="diagrams/environments/binding.png" style="display:inline-block;width:80%" /></p>
<p>在這個案例中,<code>f()</code>繫結的環境物件,就是繫結名稱<code>f</code>的環境。但並不一定總是這樣，例如在下一個例子中,<code>g</code>被繫結在新環境物件<code>e</code>中。但是函數<code>g()</code>繫結的是global environment。這之間的分別是我們如何找到<code>g</code>和<code>g</code>如何找到他的變數。</p>
<pre class="r"><code>e &lt;- env()
e$g &lt;- function() 1</code></pre>
<p><img src="diagrams/environments/binding-2.png" style="display:inline-block;width:80%" /></p>
</div>
<div id="namespaces" class="section level3">
<h3>Namespaces</h3>
<p>在上面的圖形中,我們已經知道套件的parent會隨著之前套件載入的順序不同而不同。這就導致R程式設計者必須保證個別套件上如果使用別的套件的函數，必須是原始目的的那一個。<em>namespaces</em> 就是為此目的而產生: 每個套件必須的使用必須一致,而不管使用者如何載入套件.</p>
<p>以 <code>sd()</code>為例子:</p>
<pre class="r"><code>sd</code></pre>
<pre class="rchunk output"><code>function (x, na.rm = FALSE) 
sqrt(var(if (is.vector(x) || is.factor(x)) x else as.double(x), 
    na.rm = na.rm))
&lt;bytecode: 0x000000001392f7d0&gt;
&lt;environment: namespace:stats&gt;</code></pre>
<p><code>sd()</code> 必須使用函數 <code>var()</code>, 因此這個<code>var()</code>到底來自 global environment,還是其他接入(attached)的套件的這種問題必須避免。 R avoids this problem by taking advantage of the function vs. binding environment described above.</p>
<p>每個套件中的函數和一對環境物件有關:套件環境(之前學到的)還有<em>namespace</em>環境物件。</p>
<ul>
<li><p>package environment: 是套件的外部介面，這是R使用者如何在接入的套件中尋找函數的地方(或者可以利用 <code>::</code>) package enviromnent 的parent 由搜尋路徑決定(可以利用<code>search()</code>知道)決定(也就是載入的順序)</p></li>
<li><p>namespace environment:是套件的內部介面。package environment 控制我們如何找到函數,而namespace environment控制函數如何找到變數。</p></li>
</ul>
<p>在package environment的每個繫結也可以在namespace environment中找到。這樣可以確保每個函數可以使用套件中的其他函數。但是有些繫結只能在namespace 中找到(例如內部或非輸出物件),這種內部物件通常是用來隱藏一些繁瑣的且不需要給使用者看到的細節。;</p>
<p><img src="diagrams/environments/namespace-bind.png" style="display:inline-block;width:80%" /></p>
<p>每個namespace environment 有一樣的祖集合:</p>
<ul>
<li><p>每個namespace有<em>imports</em>的環境物件，其中包含了套件中用到的所有函數繫結。而所謂<a href="#imports-environment">輸入環境</a>實際由套裝開發人員在檔案<code>NAMESPACE</code>指定</p></li>
<li><p>明確的輸入每個<code>base</code>函數,很繁瑣,所以R直接設定<code>import enviroment</code>的parent是<code>base *namespae*</code>[^1]。</p>
<div class="sidebar">
<p>The base namespace contains the same bindings as the base environment, but it has different parent.</p>
</div></li>
<li><p><em>base namespace</em> 的parent是總體環境(#global environment).參考下圖,這種設計導致在import environment中找不到繫結時,會開始再總體環境中尋找,而之前提過總體環境通常是互動環境下名稱搜尋的開始路徑,這也導致搜尋的方式受到套件載入順序的影響。因此,R提供了了<code>R CMD check</code>來警告此種情況的發生。(雖然有麻煩,但是由於S3 方法的dispatch 關係,此種方式仍然留著)</p></li>
</ul>
<p><img src="diagrams/environments/namespace-env.png" style="display:inline-block;width:80%" /></p>
<p>綜合上述,可以得到下圖::</p>
<p><img src="diagrams/environments/namespace.png" style="display:inline-block;width:80%" /></p>
<p>所以當 <code>sd()</code> 搜尋<code>var</code> 的值的時候,搜尋順序是受到開發者的指定(在檔案NAMESPACE利用import)，而不會受到套裝使用者的影響。這樣保證每次套件程式碼執行的時候,都一樣,而不會受到一般使用者載入套件的順序而影響。</p>
<p>注意在package和namespace兩種環境之間沒有直接的連結.連結是由<em>函數環境</em>定義。</p>
</div>
<div id="execution-environments" class="section level3">
<h3>Execution environments</h3>
<p><strong>execution</strong> environment. 下面的函數第一次執行的時候會傳回甚麼?第2次呢?</p>
<pre class="r"><code>g &lt;- function(x) {
  if (!env_has(current_env(), &quot;a&quot;)) {
    message(&quot;Defining a&quot;)
    a &lt;- 1
  } else {
    a &lt;- a + 1
  }
  a
}</code></pre>
<p>再一次利用下面的調用,確認你的答案:</p>
<pre class="r"><code>g(10)</code></pre>
<pre><code>Defining a</code></pre>
<pre class="rchunk output"><code>[1] 1</code></pre>
<pre class="r"><code>g(10)</code></pre>
<pre><code>Defining a</code></pre>
<pre class="rchunk output"><code>[1] 1</code></pre>
<pre class="r"><code>g(11)</code></pre>
<pre><code>Defining a</code></pre>
<pre class="rchunk output"><code>[1] 1</code></pre>
<p>這個函數每次執行都傳回一樣的答案,參考 <a href="#fresh-start">a fresh start</a>. 每次函數被調用的時候,一個新的環境都會被建立來主導執行。這種環境稱為<em>執行環境</em>。而<em>執行環境</em>的parent為 function environment.</p>
<p>用另一個簡單點的例子說明.
(圖中,執行環境的parent間接表示:經由函數環境).</p>
<pre class="r"><code>h &lt;- function(x) {
  # 1.
  a &lt;- 2 # 2.
  x + a
}
y &lt;- h(1) # 3.</code></pre>
<p><img src="diagrams/environments/execution.png" style="display:inline-block;width:80%" /></p>
<p>執行環境(execution environment)短暫存在,當函數執行完畢通常會被GC。在幾種情況下,會在記憶體存在比較久,第一種是回傳給另一個變數:</p>
<pre class="r"><code>h2 &lt;- function(x) {
  a &lt;- x * 2
  current_env()
}

e &lt;- h2(x = 10)
env_print(e)</code></pre>
<pre class="rchunk output"><code>&lt;environment: 000000001CCAE4E0&gt;
parent: &lt;environment: global&gt;
bindings:
 * a: &lt;dbl&gt;
 * x: &lt;dbl&gt;</code></pre>
<pre class="r"><code>fn_env(h2)</code></pre>
<pre class="rchunk output"><code>&lt;environment: R_GlobalEnv&gt;</code></pre>
<p>Another way to capture it is to return an object with a binding to that environment, like a function. The following example illustrates that idea with a function factory, <code>plus()</code>. We use that factory to create a function called <code>plus_one()</code>.</p>
<p>There’s a lot going on in the diagram because the enclosing environment of <code>plus_one()</code> is the execution environment of <code>plus()</code>.</p>
<pre class="r"><code>plus &lt;- function(x) {
  function(y) x + y
}

plus_one &lt;- plus(1)
plus_one</code></pre>
<pre class="rchunk output"><code>function(y) x + y
&lt;environment: 0x000000001d012868&gt;</code></pre>
<p><img src="diagrams/environments/closure.png" style="display:inline-block;width:80%" /></p>
<p>What happens when we call <code>plus_one()</code>? Its execution environment will have the captured execution environment of <code>plus()</code> as its parent:</p>
<pre class="r"><code>plus_one(2)</code></pre>
<pre class="rchunk output"><code>[1] 3</code></pre>
<p><img src="diagrams/environments/closure-call.png" style="display:inline-block;width:80%" /></p>
<p>You’ll learn more about function factories in <a href="#functional-programming">functional programming</a>.</p>
</div>
<div id="exercises-2" class="section level3">
<h3>Exercises</h3>
<ol style="list-style-type: decimal">
<li><p>How is <code>search_envs()</code> different to <code>env_parents(global_env())</code>?</p></li>
<li><p>Draw a diagram that shows the enclosing environments of this function:</p>
<pre class="r"><code>f1 &lt;- function(x1) {
  f2 &lt;- function(x2) {
    f3 &lt;- function(x3) {
      x1 + x2 + x3
    }
    f3(3)
  }
  f2(2)
}
f1(1)</code></pre></li>
<li><p>Write an enhanced version of <code>str()</code> that provides more information
about functions. Show where the function was found and what environment
it was defined in.</p></li>
</ol>
</div>
</div>
<div id="the-call-stack" class="section level2">
<h2>The call stack</h2>
<p>還有另一種環境稱為 <strong>caller</strong> environment, 可以經由 <code>rlang::caller_env()</code>存取。. This provides the environment from which the function was called, and hence varies based on how the function is called, not how the function was created. As we saw above this is a useful default whenever you write a function that takes an environment as an argument.</p>
<div class="base">
<p><code>parent.frame()</code> is equivalent to <code>caller_env()</code>; just note that it returns an environment, not a frame.</p>
</div>
<p>To fully understand the caller environment we need to discuss two related concepts: the <strong>call stack</strong>, which is made up of <strong>frames</strong>. Executing a function creates two types of context. You’ve learned about one already: the execution environment is a child of the function environment, which is determined by where the function was created. There’s another type of context created by where the function was called: this is called the call stack.</p>
<p>There are also a couple of small wrinkles when it comes to custom evaluation. See <a href="#eval-frame">environments vs. frames</a> for more details.</p>
<div id="simple-call-stacks" class="section level3">
<h3>Simple call stacks</h3>
<p>Let’s illustrate this with a simple sequence of calls: <code>f()</code> calls <code>g()</code> calls <code>h()</code>.</p>
<pre class="r"><code>f &lt;- function(x) {
  g(x = 2)
}
g &lt;- function(x) {
  h(x = 3)
}
h &lt;- function(x) {
  stop()
}</code></pre>
<p>The way you most commonly see a call stack in R is by looking at the <code>traceback()</code> after an error has occured:</p>
<pre class="r"><code>f(x = 1)
#&gt; Error:
traceback()
#&gt; 4: stop()
#&gt; 3: h(x = 3) 
#&gt; 2: g(x = 2)
#&gt; 1: f(x = 1)</code></pre>
<p>Instead of <code>stop()</code> + <code>traceback()</code> to understand the call stack, we’re going to use <code>lobstr::cst()</code> to print out the <strong>c</strong>all <strong>s</strong>tack <strong>t</strong>ree:</p>
<pre class="r"><code>h &lt;- function(x) {
  lobstr::cst()
}
f(x = 1)
#&gt; ???
#&gt; ???f(x = 1)
#&gt;   ???g(x = 2)
#&gt;     ???h(x = 3)
#&gt;       ???lobstr::cst()</code></pre>
<p>This shows us that <code>cst()</code> was called from <code>h()</code>, which was called from <code>g()</code>, which was called from <code>f()</code>. Note that the order is the opposite from <code>traceback()</code>. As the call stacks get more compliated, I think it’s easier to understand the sequence of calls if you start from the beginning, rather than the end (i.e. <code>f()</code> calls <code>g()</code>; rather than <code>g()</code> was called by <code>f()</code>).</p>
</div>
<div id="lazy-evaluation" class="section level3">
<h3>Lazy evaluation</h3>
<p>The call stack above is simple - while you get a hint that there’s some tree-like structure involved, everything happens on a single branch. This is typical of a call stack when all arguments are eagerly evaluated.</p>
<p>Let’s create a more complicated example that involves some lazy evaluation. We’ll create a sequence of functions, <code>a()</code>, <code>b()</code>, <code>c()</code>, that pass along an argument <code>x</code>.</p>
<pre class="r"><code>a &lt;- function(x) b(x)
b &lt;- function(x) c(x)
c &lt;- function(x) x

a(f())
#&gt; ???
#&gt; ???a(f())
#&gt; ??? ???b(x)
#&gt; ???   ???c(x)
#&gt; ???f()
#&gt;   ???g(x = 2)
#&gt;     ???h(x = 3)
#&gt;       ???lobstr::cst()</code></pre>
<p><code>x</code> is lazily evaluated so this tree gets two branches. In the first branch <code>a()</code> calls <code>b()</code>, then <code>b()</code> calls <code>c()</code>. The second branch starts when <code>c()</code> evaluates its argument <code>x</code>. This argument is evaluated in a new branch because the environment in which it is evaluated is the global environment, not the environment of <code>c()</code>.</p>
</div>
<div id="frames" class="section level3">
<h3>Frames</h3>
<p>Each element of the call stack is a <strong>frame</strong><a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>, also known as an evaluation context.
The frame is an extremely important internal data structure, and R code can only access a small part of the data structure because it’s so critical. A frame has three main components that are accessible from R:</p>
<ul>
<li><p>An expression (labelled with <code>expr</code>) giving the function call. This is
what <code>traceback()</code> prints out.</p></li>
<li><p>An environment (labelled with <code>env</code>), which is typically the execution
environment of a function. There are two main exceptions: the environment of
the global frame is the global environment, and calling <code>eval()</code> also
generates frames, where the environment can be anything.</p></li>
<li><p>A parent, the previous call in the call stack (shown by a grey arrow).</p></li>
</ul>
<p><img src="diagrams/environments/calling.png" style="display:inline-block;width:80%" /></p>
<p>(To focus on the calling environments, I have omitted the bindings in the global environment from <code>f</code>, <code>g</code>, and <code>h</code> to the respective function objects.)</p>
<p>The frame also holds exit handlers created with <code>on.exit()</code>, restarts and handlers for the condition system, and which context to <code>return()</code> to when a function completes. These are important for the internal operation of R, but are not directly accessible.</p>
</div>
<div id="dynamic-scope" class="section level3">
<h3>Dynamic scope</h3>
<p>Looking up variables in the calling stack rather than in the enclosing environment is called <strong>dynamic scoping</strong>. Few languages implement dynamic scoping (Emacs Lisp is a <a href="http://www.gnu.org/software/emacs/emacs-paper.html#SEC15">notable exception</a>.) This is because dynamic scoping makes it much harder to reason about how a function operates: not only do you need to know how it was defined, you also need to know the context in which it was called. Dynamic scoping is primarily useful for developing functions that aid interactive data analysis. It is one of the topics discussed in <a href="#nse">non-standard evaluation</a>.</p>
</div>
<div id="exercises-3" class="section level3">
<h3>Exercises</h3>
<ol style="list-style-type: decimal">
<li>Write a function that lists all the variables defined in the environment
in which it was called. It should return the same results as <code>ls()</code>.</li>
</ol>
</div>
</div>
<div id="explicit-envs" class="section level2">
<h2>As data structures</h2>
<p>As well as powering scoping, environments are also useful data structures in their own right because they have reference semantics. There are three common problems that they can help solve:</p>
<ul>
<li><p><strong>Avoiding copies of large data</strong>. Since environments have reference semantics,
you’ll never accidentally create a copy. This makes it a useful vessel for
large objects. Bare environments are not that pleasant to work with;
I recommend using R6 objects instead. Learn more in [R6].</p></li>
<li><p><strong>Managing state within a package</strong>. Explicit environments are useful in
packages because they allow you to maintain state across function calls.
Normally, objects in a package are locked, so you can’t modify them
directly. Instead, you can do something like this:</p>
<pre class="r"><code>my_env &lt;- new.env(parent = emptyenv())
my_env$a &lt;- 1

get_a &lt;- function() {
  my_env$a
}
set_a &lt;- function(value) {
  old &lt;- my_env$a
  my_env$a &lt;- value
  invisible(old)
}</code></pre>
<p>Returning the old value from setter functions is a good pattern because
it makes it easier to reset the previous value in conjunction with
<code>on.exit()</code> (see more in <a href="#on-exit">on exit</a>).</p></li>
<li><p><strong>As a hashmap</strong>. A hashmap is a data structure that takes constant, O(1),
time to find an object based on its name. Environments provide this
behaviour by default, so can be used to simulate a hashmap. See the
CRAN package hash for a complete development of this idea.</p></li>
</ul>
</div>
<div id="section" class="section level2">
<h2><code>&lt;&lt;-</code></h2>
<p>The ancestors of an environment have an important relationship to <code>&lt;&lt;-</code>. The regular assignment arrow, <code>&lt;-</code>, always creates a variable in the current environment. The deep assignment arrow, <code>&lt;&lt;-</code>, never creates a variable in the current environment, but instead modifies an existing variable found by walking up the parent environments.</p>
<pre class="r"><code>x &lt;- 0
f &lt;- function() {
  x &lt;&lt;- 1
}
f()
x</code></pre>
<pre class="rchunk output"><code>[1] 1</code></pre>
<p>If <code>&lt;&lt;-</code> doesn’t find an existing variable, it will create one in the global environment. This is usually undesirable, because global variables introduce non-obvious dependencies between functions. <code>&lt;&lt;-</code> is most often used in conjunction with a closure, as described in <a href="#closures">Closures</a>.</p>
<div id="exercises-4" class="section level3">
<h3>Exercises</h3>
<ol style="list-style-type: decimal">
<li><p>What does this function do? How does it differ from <code>&lt;&lt;-</code> and why
might you prefer it?</p>
<pre class="r"><code>rebind &lt;- function(name, value, env = caller_env()) {
  if (identical(env, empty_env())) {
    stop(&quot;Can&#39;t find `&quot;, name, &quot;`&quot;, call. = FALSE)
  } else if (env_has(env, name)) {
    env_poke(env, name, value)
  } else {
    rebind(name, value, env_parent(env))
  }
}
rebind(&quot;a&quot;, 10)</code></pre>
<pre><code>Error: Can&#39;t find `a`</code></pre>
<pre class="r"><code>a &lt;- 5
rebind(&quot;a&quot;, 10)
a</code></pre>
<pre class="rchunk output"><code>[1] 10</code></pre></li>
</ol>
</div>
</div>
<div id="env-answers" class="section level2">
<h2>Quiz answers</h2>
<ol style="list-style-type: decimal">
<li><p>There are four ways: every object in an environment must have a name;
order doesn’t matter; environments have parents; environments have
reference semantics.</p></li>
<li><p>The parent of the global environment is the last package that you
loaded. The only environment that doesn’t have a parent is the empty
environment.</p></li>
<li><p>The enclosing environment of a function is the environment where it
was created. It determines where a function looks for variables.</p></li>
<li><p>Use <code>caller_env()</code> or <code>parent.frame()</code>.</p></li>
<li><p><code>&lt;-</code> always creates a binding in the current environment; <code>&lt;&lt;-</code>
rebinds an existing name in a parent of the current environment.</p></li>
</ol>
<div id="term" class="section level3">
<h3>term</h3>
<div id="global-environment" class="section level5">
<h5>global environment :總體環境</h5>
</div>
<div id="package-environments" class="section level5">
<h5>package environments</h5>
</div>
<div id="imports-environment" class="section level5">
<h5>imports environment</h5>
</div>
</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>You might wonder why rlang has <code>env_poke()</code> instead of <code>env_set()</code>.
This is for consistency: <code>_set()</code> functions return a modified copy;
<code>_poke()</code> functions modify in place.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>NB: <code>?environment</code> uses frame in a different sense: “Environments consist of a <em>frame</em>, or collection of named objects, and a pointer to an enclosing environment.”. We avoid this sense of frame, which comes from S, because it’s very specific and not widely used in base R. For example, the “frame” in <code>parent.frame()</code> is an execution context, not a collection of named objects.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
</ol>
</div>


<footer class="footline">
	
</footer>

        
        </div>
        
rlang\Environments.html
      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="../rlang/plot02.html" title="更多繪圖"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="../rlang/sampling.html" title="sampling" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="../js/clipboard.min.js?1604543915"></script>
    <script src="../js/perfect-scrollbar.min.js?1604543915"></script>
    <script src="../js/perfect-scrollbar.jquery.min.js?1604543915"></script>
    <script src="../js/jquery.sticky.js?1604543915"></script>
    <script src="../js/featherlight.min.js?1604543915"></script>
    <script src="../js/highlight.pack.js?1604543915"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="../js/modernizr.custom-3.6.0.js?1604543915"></script>
    <script src="../js/learn.js?1604543915"></script>
    <script src="../js/hugo-learn.js?1604543915"></script>
    
        
            <script src="../mermaid/mermaid.js?1604543915"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    



  </body>
</html>

